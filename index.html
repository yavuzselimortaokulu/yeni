<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Öğrenci Paneli - Soru Takip</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts (Inter) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Chart.js (Grafikler için) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <style>
        /* Ana Font Ailesi */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a103c; /* Mor tema için koyu arka plan */
        }

        /* Sekme İçeriklerini Yönetme */
        .tab-content {
            display: none; /* Aktif olmayan sekmeyi gizle */
        }
        .tab-content.active {
            display: block; /* Aktif sekmeyi göster */
        }

        /* "Buzlu Cam" (Glassmorphism) Kart Stili */
        .glass-card {
            background-color: rgba(67, 30, 143, 0.5); /* Yarı şeffaf mor */
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1.5rem; /* Daha yuvarlak kenarlar */
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        }
        
        /* Aktif Sekme Butonu Stili (Görseldeki gibi) */
        .tab-button.active {
            background-color: #8B5CF6; /* Canlı Mor */
            color: white;
            font-weight: 600;
        }
        .tab-button {
            color: #D1D5DB; /* Soluk beyaz/gri */
            font-weight: 500;
        }

        /* Tablo Stilleri */
        th, td {
            padding: 0.75rem 1rem;
            text-align: left;
        }
        thead th {
            color: #a78bfa; /* Mor başlık */
            font-weight: 600;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        tbody tr {
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        tbody tr:last-child {
            border-bottom: none;
        }

        /* --- Günlük Rapor (Takvim) Stilleri --- */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }
        .calendar-header {
            text-align: center;
            font-weight: 600;
            color: #c4b5fd; /* Açık Mor */
            padding-bottom: 8px;
        }
        .day-cell {
            position: relative;
            padding-top: 100%; /* Kare hücreler oluşturur */
            cursor: pointer;
            border-radius: 0.5rem; /* Hafif yuvarlatılmış */
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .day-cell-content {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
            border-radius: 0.5rem;
            transition: all 0.2s ease-in-out;
        }
        .day-cell.other-month .day-cell-content {
            opacity: 0.2;
            cursor: default;
        }
        .day-cell.today .day-cell-content {
            background-color: rgba(255, 255, 255, 0.1); /* Bugün */
            font-weight: 700;
        }
        .day-cell:not(.other-month):hover .day-cell-content {
            background-color: rgba(139, 92, 246, 0.3); /* Mor hover */
        }
        .day-cell.selected .day-cell-content {
            background-color: transparent;
            border: 2px solid #a78bfa; /* Seçili (Halka stili) */
            font-weight: 700;
        }
        .day-marker {
            position: absolute;
            bottom: 4px;
            left: 50%;
            transform: translateX(-50%);
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: #f87171; /* Kırmızı Nokta */
        }
        /* --- Bitiş: Takvim Stilleri --- */

    </style>
</head>
<body class="bg-gradient-to-br from-purple-800 to-indigo-900 text-gray-200 min-h-screen">

    <!-- Üst Navigasyon Çubuğu -->
    <nav class="bg-purple-950/50 backdrop-blur-sm border-b border-white/10 p-4 sticky top-0 z-50">
        <div class="container mx-auto max-w-7xl flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <!-- SVG Kitap Logosu -->
                <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 text-purple-300" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
                    <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
                </svg>
                <span class="text-xl font-bold text-white">SORU TAKİP PROGRAMI</span>
                <span class="text-lg font-medium text-gray-300 hidden sm:block">| YAVUZ SELİM ORTAOKULU</span>
            </div>
            <div class="flex items-center space-x-4">
                <span id="welcome-message" class="text-gray-300 font-medium">Yükleniyor...</span>
                <button id="logout-button" class="bg-purple-600 hover:bg-purple-700 text-white font-medium py-2 px-4 rounded-lg transition duration-200">
                    Çıkış Yap
                </button>
            </div>
        </div>
    </nav>

    <!-- Ana İçerik Alanı -->
    <main class="p-4 sm:p-8">
        <div class="container mx-auto max-w-7xl">
            
            <!-- Sekme Butonları (Görseldeki gibi) -->
            <div class="glass-card p-2 mb-6">
                <div id="tab-buttons" class="flex items-center justify-between sm:justify-start sm:space-x-2">
                    <button class="tab-button flex-1 sm:flex-none py-3 px-4 rounded-lg text-sm sm:text-base font-medium transition-all duration-200" data-tab="soru-girisi">Soru Girişi</button>
                    <button class="tab-button flex-1 sm:flex-none py-3 px-4 rounded-lg text-sm sm:text-base font-medium transition-all duration-200" data-tab="gunluk-rapor">Günlük Rapor</button>
                    <button class="tab-button flex-1 sm:flex-none py-3 px-4 rounded-lg text-sm sm:text-base font-medium transition-all duration-200" data-tab="haftalik-rapor">Haftalık Rapor</button>
                    <button class="tab-button flex-1 sm:flex-none py-3 px-4 rounded-lg text-sm sm:text-base font-medium transition-all duration-200" data-tab="aylik-rapor">Aylık Rapor</button>
                </div>
            </div>

            <!-- Sekme İçerikleri -->
            <div id="tab-contents" class="space-y-6">

                <!-- 1. Soru Girişi Sekmesi -->
                <div id="soru-girisi" class="tab-content">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        
                        <!-- Sol Taraf: Soru Ekle Formu (Resimdeki gibi) -->
                        <div class="lg:col-span-1">
                            <div class="glass-card p-6 h-full">
                                <h2 class="text-2xl font-bold text-white mb-6">Soru Ekle</h2>
                                <form id="soruEkleForm" class="space-y-5">
                                    <div>
                                        <label for="dersSelect" class="block text-sm font-medium text-gray-300 mb-1">Ders</label>
                                        <select id="dersSelect" class="w-full p-3 bg-purple-800/60 border border-white/20 rounded-lg text-white focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none">
                                            <option value="" disabled selected>Ders Seçin...</option>
                                            <!-- Dersler JS ile doldurulacak -->
                                        </select>
                                    </div>

                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <label for="dogruInput" class="block text-sm font-medium text-gray-300 mb-1">Doğru</label>
                                            <input type="number" id="dogruInput" value="0" min="0" class="w-full p-3 bg-purple-800/60 border border-white/20 rounded-lg text-white focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none">
                                        </div>
                                        <div>
                                            <label for="yanlisInput" class="block text-sm font-medium text-gray-300 mb-1">Yanlış</label>
                                            <input type="number" id="yanlisInput" value="0" min="0" class="w-full p-3 bg-purple-800/60 border border-white/20 rounded-lg text-white focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none">
                                        </div>
                                    </div>
                                    
                                    <button type="submit" class="w-full bg-purple-600 text-white py-3 px-4 rounded-lg hover:bg-purple-700 font-bold transition duration-150 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 focus:ring-offset-purple-900">
                                        Kaydet
                                    </button>
                                    <p id="formSuccessMessage" class="text-green-400 text-center font-medium hidden">Soru başarıyla eklendi!</p>
                                </form>
                            </div>
                        </div>

                        <!-- Sağ Taraf: İstatistikler ve Son Eklenenler -->
                        <div class="lg:col-span-2 space-y-6">
                            <!-- İstatistik Kartları -->
                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                                <div class="glass-card p-6 text-center">
                                    <h3 class="text-base font-semibold text-purple-300 uppercase tracking-wider">BUGÜN ÇÖZÜLEN</h3>
                                    <p id="stats-bugun" class="text-5xl font-extrabold text-white mt-2">0</p>
                                </div>
                                <div class="glass-card p-6 text-center">
                                    <h3 class="text-base font-semibold text-purple-300 uppercase tracking-wider">HAFTALIK TOPLAM</h3>
                                    <p id="stats-hafta" class="text-5xl font-extrabold text-white mt-2">0</p>
                                </div>
                                <div class="glass-card p-6 text-center">
                                    <h3 class="text-base font-semibold text-purple-300 uppercase tracking-wider">GENEL BAŞARI</h3>
                                    <p id="stats-basari" class="text-5xl font-extrabold text-white mt-2">0%</p>
                                </div>
                            </div>
                            
                            <!-- Son Eklenenler Tablosu (Resimdeki gibi) -->
                            <div class="glass-card p-6">
                                <h3 class="text-xl font-bold text-white mb-4">Son Eklenenler</h3>
                                <div class="overflow-x-auto">
                                    <table class="w-full min-w-[400px]">
                                        <thead>
                                            <tr>
                                                <th>DERS</th>
                                                <th>D</th>
                                                <th>Y</th>
                                                <th>TOPLAM</th>
                                                <th>TARİH</th>
                                            </tr>
                                        </thead>
                                        <tbody id="sonEklenenlerBody">
                                            <tr><td colspan="5" class="text-center p-4">Yükleniyor...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 2. Günlük Rapor Sekmesi -->
                <div id="gunluk-rapor" class="tab-content">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Takvim -->
                        <div class="glass-card p-6">
                            <div class="flex justify-between items-center mb-4">
                                <button id="prev-month" class="p-2 rounded-md hover:bg-purple-700/50 transition-colors">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                                </button>
                                <h3 id="month-year-header" class="text-xl font-bold text-white">Ekim 2025</h3>
                                <button id="next-month" class="p-2 rounded-md hover:bg-purple-700/50 transition-colors">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                                </button>
                            </div>
                            <div class="calendar-header-grid grid grid-cols-7 gap-4 mb-2">
                                <div class="calendar-header">PZT</div>
                                <div class="calendar-header">SAL</div>
                                <div class="calendar-header">ÇAR</div>
                                <div class="calendar-header">PER</div>
                                <div class="calendar-header">CUM</div>
                                <div class="calendar-header">CMT</div>
                                <div class="calendar-header">PAZ</div>
                            </div>
                            <div id="calendar-grid-body" class="calendar-grid">
                                <!-- JS ile doldurulacak -->
                            </div>
                        </div>
                        
                        <!-- Günlük Detay Tablosu -->
                        <div class="glass-card p-6">
                            <h3 class="text-xl font-bold text-white mb-4">Günlük Detay</h3>
                            <p id="gunlukDetayTarih" class="text-lg text-purple-300 font-semibold mb-4">Detay görmek için bir gün seçin.</p>
                            <div id="gunlukDetayWrapper" class="hidden overflow-x-auto">
                                <table class="w-full">
                                    <thead>
                                        <tr>
                                            <th>DERS</th>
                                            <th>D</th>
                                            <th>Y</th>
                                            <th>TOPLAM</th>
                                        </tr>
                                    </thead>
                                    <tbody id="gunlukDetayBody">
                                        <!-- JS ile doldurulacak -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 3. Haftalık Rapor Sekmesi -->
                <div id="haftalik-rapor" class="tab-content">
                    <div class="glass-card p-6">
                        <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-4 gap-4">
                            <h3 class="text-xl font-bold text-white">Haftalık Rapor</h3>
                            <select id="haftaSelect" class="w-full sm:w-64 p-2 bg-purple-800/60 border border-white/20 rounded-lg text-white focus:ring-2 focus:ring-purple-400 outline-none">
                                <!-- JS ile doldurulacak -->
                            </select>
                        </div>
                        
                        <!-- Grafik Alanı -->
                        <div class="mb-6 relative h-64 sm:h-80">
                            <canvas id="haftalikChartCanvas"></canvas>
                        </div>
                        
                        <!-- Detay Tablosu (Kısaltılmış) -->
                        <h4 class="text-lg font-semibold text-white mb-3 mt-8">Haftalık Ders Detayları</h4>
                        <div class="overflow-x-auto">
                            <table class="w-full text-center">
                                <thead>
                                    <tr>
                                        <th class="text-left">DERS</th>
                                        <th>PZT</th>
                                        <th>SAL</th>
                                        <th>ÇAR</th>
                                        <th>PER</th>
                                        <th>CUM</th>
                                        <th>CMT</th>
                                        <th>PAZ</th>
                                        <th>TOP</th>
                                    </tr>
                                </thead>
                                <tbody id="haftalikDetayBody">
                                    <!-- JS ile doldurulacak -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 4. Aylık Rapor Sekmesi -->
                <div id="aylik-rapor" class="tab-content">
                    <div class="glass-card p-6">
                        <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-4 gap-4">
                            <h3 class="text-xl font-bold text-white">Aylık Rapor</h3>
                            <select id="month-select" class="w-full sm:w-64 p-2 bg-purple-800/60 border border-white/20 rounded-lg text-white focus:ring-2 focus:ring-purple-400 outline-none">
                                <!-- JS ile doldurulacak -->
                            </select>
                        </div>
                        
                        <!-- Grafik Alanı -->
                        <div class="mb-6 relative h-64 sm:h-80">
                            <canvas id="monthly-chart-canvas"></canvas>
                        </div>
                        
                        <!-- Detay Tablosu -->
                        <h4 class="text-lg font-semibold text-white mb-3 mt-8">Aylık Ders Toplamları</h4>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead>
                                    <tr>
                                        <th>DERS</th>
                                        <th>TOPLAM SORU</th>
                                        <th>DOĞRU</th>
                                        <th>YANLIŞ</th>
                                        <th>BAŞARI (%)</th>
                                    </tr>
                                </thead>
                                <tbody id="monthly-details-body">
                                    <!-- JS ile doldurulacak -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <!-- Firebase ve Ana Uygulama Scripti -->
    <script type="module">
        // Firebase SDK'ları
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            signOut,
            signInWithCustomToken,
            signInAnonymously
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getDatabase, 
            ref, 
            push, 
            onValue
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

        // --- GLOBAL (GENEL) DEĞİŞKENLER ---
        // Canvas ortamından gelen değişkenler
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Sağladığınız Firebase Realtime Database URL'si
        firebaseConfig.databaseURL = "https://kocluksistemi-c00bd-default-rtdb.europe-west1.firebasedatabase.app/";

        // Firebase servislerini başlat
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        
        // Hata ayıklama logları (kaldırıldı)
        // setLogLevel('Debug');

        let currentUserId = null; // Giriş yapan kullanıcının ID'si
        let sorularRef = null; // Veritabanı referansı
        let tumSorular = []; // Tüm soruları tutan global liste
        
        // Grafik nesnelerini globalde tut (güncellemek için)
        let haftalikChartInstance = null;
        let aylikChartInstance = null;

        // Raporlar için sabitler
        const allSubjects = ["Matematik", "Türkçe", "Fen Bilimleri", "Sosyal Bilgiler", "İngilizce", "Din Kültürü"];
        const monthNames = ["Ocak", "Şubat", "Mart", "Nisan", "Mayıs", "Haziran", "Temmuz", "Ağustos", "Eylül", "Ekim", "Kasım", "Aralık"];
        const dayNamesShort = ["PZT", "SAL", "ÇAR", "PER", "CUM", "CMT", "PAZ"];

        // --- SAYFA YÜKLENDİĞİNDE ÇALIŞACAK ANA FONKSİYON ---
        document.addEventListener('DOMContentLoaded', () => {
            setupTabs(); // Sekme değiştirme mantığını kur
            setupSoruEkleForm(); // Soru Ekle formunu kur
            setupCalendar(); // Takvim mantığını kur
            setupWeeklyReport(); // Haftalık Rapor sekmesini kur
            setupMonthlyReport(); // Aylık Rapor sekmesini kur
            
            handleAuthentication(); // Kullanıcı girişini yönet
        });

        // --- 1. KİMLİK DOĞRULAMA (Authentication) ---
        
        async function handleAuthentication() {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    console.log("Kullanıcı giriş yaptı:", user.uid);
                    currentUserId = user.uid;
                    document.getElementById('welcome-message').textContent = `Hoş geldin! (ID: ${user.uid.substring(0, 6)}...)`;
                    
                    // Veritabanı referansını ayarla ve veri dinleyicisini başlat
                    sorularRef = ref(db, `/artifacts/${appId}/users/${currentUserId}/sorular`);
                    startDataListener();
                } else {
                    console.log("Kullanıcı bulunamadı, token ile giriş deneniyor...");
                    // Token varsa onunla, yoksa anonim giriş yap (Canvas ortamı için)
                    signInUser(); 
                }
            });

            // Çıkış Yap butonu
            document.getElementById('logout-button').addEventListener('click', () => {
                signOut(auth).catch((error) => console.error("Çıkış hatası:", error));
                // Gerçek bir uygulamada giriş sayfasına yönlendirilir
                window.location.href = 'index.html'; // Giriş sayfasına (anasayfa) yönlendir
            });
        }

        async function signInUser() {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log("Custom token ile giriş yapıldı.");
                } else {
                    await signInAnonymously(auth);
                    console.log("Anonim giriş yapıldı.");
                }
            } catch (error) {
                console.error("Giriş hatası:", error);
                document.getElementById('welcome-message').textContent = "Giriş Başarısız!";
            }
        }

        // --- 2. VERİ DİNLEYİCİ (TÜM GÜNCELLEMELERİN KAYNAĞI) ---

        function startDataListener() {
            if (!sorularRef) return;
            
            onValue(sorularRef, (snapshot) => {
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    // Firebase RTDB verisini { key: { ... } } formatından [ { ... } ] formatına çevir
                    tumSorular = Object.keys(data).map(key => ({
                        id: key,
                        ...data[key],
                        // Tarih string'ini Date nesnesine çevir (sıralama/filtreleme için önemli)
                        tarih: new Date(data[key].tarih) 
                    }));
                    
                    // Veriyi tarihe göre sırala (en yeni en üstte)
                    tumSorular.sort((a, b) => b.tarih - a.tarih);
                    
                    console.log("Firebase'den veri alındı:", tumSorular.length, "kayıt");
                    
                    // Tüm sekmeleri ve kartları yeni veriyle güncelle
                    updateSoruGirisiTab(tumSorular);
                    updateGunlukRaporTab(tumSorular);
                    updateHaftalikRaporTab(tumSorular);
                    updateAylikRaporTab(tumSorular);
                    
                } else {
                    console.log("Bu kullanıcı için veri bulunamadı.");
                    tumSorular = []; // Veri yoksa listeyi boşalt
                    // Tüm sekmeleri ve kartları boş veriyle güncelle
                    updateSoruGirisiTab(tumSorular);
                    updateGunlukRaporTab(tumSorular);
                    updateHaftalikRaporTab(tumSorular);
                    updateAylikRaporTab(tumSorular);
                }
            });
        }

        // --- 3. SEKMELERİ GÜNCELLEME FONKSİYONLARI ---

        // "Soru Girişi" sekmesini günceller
        function updateSoruGirisiTab(sorular) {
            updateIstatistikKartlari(sorular);
            updateSonEklenenler(sorular);
        }

        // "Günlük Rapor" sekmesini günceller
        function updateGunlukRaporTab(sorular) {
            // Takvimi yeniden çizerken (renderCalendar) soru olan günleri işaretler
            const markedDates = new Set(sorular.map(s => s.tarih.toISOString().split('T')[0]));
            renderCalendar(currentDisplayDate, markedDates);
            
            // Eğer bir gün seçiliyse, o günün detay tablosunu da güncelle
            updateGunlukDetayTablosu();
        }

        // "Haftalık Rapor" sekmesini günceller
        function updateHaftalikRaporTab(sorular) {
            // Sadece mevcut seçili haftanın grafiğini ve tablosunu güncelle
            updateWeeklyChartAndTable(sorular);
        }
        
        // "Aylık Rapor" sekmesini günceller
        function updateAylikRaporTab(sorular) {
            // Sadece mevcut seçili ayın grafiğini ve tablosunu güncelle
            updateMonthlyChartAndTable(sorular);
        }

        // --- 4. SEKME YÖNETİMİ (TAB SWITCHING) ---

        function setupTabs() {
            const tabButtonsContainer = document.getElementById('tab-buttons');
            const tabContentsContainer = document.getElementById('tab-contents');

            tabButtonsContainer.addEventListener('click', (e) => {
                const clickedButton = e.target.closest('.tab-button');
                if (!clickedButton) return;

                const targetTabId = clickedButton.dataset.tab;
                
                // Tüm butonlardan 'active' stilini kaldır
                tabButtonsContainer.querySelectorAll('.tab-button').forEach(btn => {
                    btn.classList.remove('active', 'bg-purple-600', 'text-white', 'font-semibold');
                    btn.classList.add('text-gray-300', 'font-medium');
                });
                
                // Tıklanan butona 'active' stilini ekle
                clickedButton.classList.add('active', 'bg-purple-600', 'text-white', 'font-semibold');
                clickedButton.classList.remove('text-gray-300', 'font-medium');

                // Tüm içerik bloklarını gizle
                tabContentsContainer.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                
                // Hedef içeriği göster
                document.getElementById(targetTabId).classList.add('active');
            });

            // Varsayılan olarak ilk sekmeyi aktif yap
            tabButtonsContainer.querySelector('.tab-button').click();
        }

        // --- 5. "SORU GİRİŞİ" SEKME FONKSİYONLARI ---

        // Formu (Ders seçici ve Kaydetme) kurar
        function setupSoruEkleForm() {
            const form = document.getElementById('soruEkleForm');
            const dersSelect = document.getElementById('dersSelect');
            const dogruInput = document.getElementById('dogruInput');
            const yanlisInput = document.getElementById('yanlisInput');
            const successMessage = document.getElementById('formSuccessMessage');

            // Ders seçiciyi doldur
            allSubjects.forEach(ders => {
                const option = document.createElement('option');
                option.value = ders;
                option.textContent = ders;
                dersSelect.appendChild(option);
            });

            // Form gönderildiğinde (Kaydet butonu)
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                
                const ders = dersSelect.value;
                const dogru = parseInt(dogruInput.value) || 0;
                const yanlis = parseInt(yanlisInput.value) || 0;

                if (!ders) {
                    alert("Lütfen bir ders seçin.");
                    return;
                }
                
                if (dogru === 0 && yanlis === 0) {
                    alert("Lütfen en az bir doğru veya yanlış sayısı girin.");
                    return;
                }
                
                if (!currentUserId || !sorularRef) {
                    alert("Veritabanı bağlantısı kurulamadı. Lütfen tekrar deneyin.");
                    return;
                }

                // Veriyi Firebase'e push et
                push(sorularRef, {
                    ders: ders,
                    dogru: dogru,
                    yanlis: yanlis,
                    tarih: new Date().toISOString() // Kayıt anının tarihi
                })
                .then(() => {
                    // Formu sıfırla
                    form.reset();
                    dersSelect.value = ""; // "Ders Seçin..."e geri dön
                    dogruInput.value = "0";
                    yanlisInput.value = "0";
                    
                    // Başarı mesajı
                    successMessage.classList.remove('hidden');
                    setTimeout(() => successMessage.classList.add('hidden'), 2000);
                })
                .catch((error) => {
                    console.error("Veri ekleme hatası:", error);
                    alert("Bir hata oluştu: " + error.message);
                });
            });
        }

        // İstatistik Kartlarını günceller
        function updateIstatistikKartlari(sorular) {
            const bugunBaslangic = new Date();
            bugunBaslangic.setHours(0, 0, 0, 0);

            const buHaftaPazartesi = getStartOfWeek(new Date());

            let bugunToplam = 0;
            let haftaToplam = 0;
            let toplamDogru = 0;
            let toplamYanlis = 0;

            sorular.forEach(soru => {
                const soruTarihi = soru.tarih;
                const dogru = soru.dogru || 0;
                const yanlis = soru.yanlis || 0;
                const toplam = dogru + yanlis;

                toplamDogru += dogru;
                toplamYanlis += yanlis;

                if (soruTarihi >= bugunBaslangic) {
                    bugunToplam += toplam;
                }
                if (soruTarihi >= buHaftaPazartesi) {
                    haftaToplam += toplam;
                }
            });

            const toplamSoru = toplamDogru + toplamYanlis;
            const basariYuzdesi = (toplamSoru > 0) ? Math.round((toplamDogru / toplamSoru) * 100) : 0;

            document.getElementById('stats-bugun').textContent = bugunToplam;
            document.getElementById('stats-hafta').textContent = haftaToplam;
            document.getElementById('stats-basari').textContent = `${basariYuzdesi}%`;
        }

        // "Son Eklenenler" tablosunu günceller
        function updateSonEklenenler(sorular) {
            const tbody = document.getElementById('sonEklenenlerBody');
            tbody.innerHTML = ''; // Tabloyu temizle

            if (sorular.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center p-4">Henüz soru eklenmemiş.</td></tr>';
                return;
            }

            const sonEklenenler = sorular.slice(0, 5); // Zaten sıralı, ilk 5'i al
            
            sonEklenenler.forEach(soru => {
                const dogru = soru.dogru || 0;
                const yanlis = soru.yanlis || 0;
                const toplam = dogru + yanlis;
                const tarihStr = soru.tarih.toLocaleDateString('tr-TR'); // Örn: 29.10.2025

                const row = `
                    <tr>
                        <td class="font-medium text-white">${soru.ders}</td>
                        <td class="text-green-400">${dogru}</td>
                        <td class="text-red-400">${yanlis}</td>
                        <td class="text-white">${toplam}</td>
                        <td class="text-gray-400">${tarihStr}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        // --- 6. "GÜNLÜK RAPOR" SEKME FONKSİYONLARI (TAKVİM) ---

        let currentDisplayDate = new Date(); // Takvimde o an gösterilen ay
        let selectedDate = null; // Takvimde seçilen gün

        function setupCalendar() {
            document.getElementById('prev-month').addEventListener('click', () => {
                currentDisplayDate.setMonth(currentDisplayDate.getMonth() - 1);
                updateGunlukRaporTab(tumSorular); // Tüm sorularla takvimi yeniden çiz
            });
            document.getElementById('next-month').addEventListener('click', () => {
                currentDisplayDate.setMonth(currentDisplayDate.getMonth() + 1);
                updateGunlukRaporTab(tumSorular); // Tüm sorularla takvimi yeniden çiz
            });
        }

        function renderCalendar(date, markedDates) {
            const gridBody = document.getElementById('calendar-grid-body');
            const header = document.getElementById('month-year-header');
            gridBody.innerHTML = '';
            
            const year = date.getFullYear();
            const month = date.getMonth();
            header.textContent = `${monthNames[month]} ${year}`;

            const firstDayOfMonth = new Date(year, month, 1);
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            // Haftanın ilk günü Pazartesi (1) olacak şekilde ayarla (0=Pazar)
            const startDayOfWeek = (firstDayOfMonth.getDay() + 6) % 7; 

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // Önceki ayın günlerini ekle
            const daysInPrevMonth = new Date(year, month, 0).getDate();
            for (let i = startDayOfWeek; i > 0; i--) {
                const day = daysInPrevMonth - i + 1;
                gridBody.innerHTML += `
                    <div class="day-cell other-month">
                        <div class="day-cell-content">${day}</div>
                    </div>
                `;
            }

            // Bu ayın günlerini ekle
            for (let day = 1; day <= daysInMonth; day++) {
                const currentDate = new Date(year, month, day);
                const dateString = currentDate.toISOString().split('T')[0];
                
                let classes = "day-cell";
                if (currentDate.getTime() === today.getTime()) classes += " today";
                if (dateString === selectedDate) classes += " selected";
                
                const hasData = markedDates.has(dateString);

                gridBody.innerHTML += `
                    <div class="${classes}" data-date="${dateString}">
                        <div class="day-cell-content">
                            ${day}
                            ${hasData ? '<div class="day-marker"></div>' : ''}
                        </div>
                    </div>
                `;
            }

            // Sonraki ayın günlerini ekle (gridi 42'ye tamamla)
            const totalCells = startDayOfWeek + daysInMonth;
            const remainingCells = 42 - totalCells; // 6 hafta * 7 gün
            for (let day = 1; day <= remainingCells; day++) {
                gridBody.innerHTML += `
                    <div class="day-cell other-month">
                        <div class="day-cell-content">${day}</div>
                    </div>
                `;
            }

            // Gün tıklama olaylarını ekle
            gridBody.querySelectorAll('.day-cell:not(.other-month)').forEach(cell => {
                cell.addEventListener('click', handleDayClick);
            });
        }
        
        function handleDayClick(e) {
            const clickedCell = e.target.closest('.day-cell');
            selectedDate = clickedCell.dataset.date;
            
            // Seçili günü güncellemek için takvimi yeniden çiz
            updateGunlukRaporTab(tumSorular);
            // Detay tablosunu bu tarih için güncelle
            updateGunlukDetayTablosu();
        }
        
        function updateGunlukDetayTablosu() {
            const wrapper = document.getElementById('gunlukDetayWrapper');
            const tbody = document.getElementById('gunlukDetayBody');
            const tarihHeader = document.getElementById('gunlukDetayTarih');
            
            if (!selectedDate) {
                tarihHeader.textContent = "Detay görmek için bir gün seçin.";
                wrapper.classList.add('hidden');
                return;
            }

            const selectedDateObj = new Date(selectedDate);
            // Tarih başlığını formatla (Örn: 29 Ekim 2025)
            tarihHeader.textContent = `${selectedDateObj.getDate()} ${monthNames[selectedDateObj.getMonth()]} ${selectedDateObj.getFullYear()}`;
            tbody.innerHTML = '';
            
            // Verileri seçilen güne göre filtrele
            const gunlukVeriler = tumSorular.filter(s => 
                s.tarih.toISOString().split('T')[0] === selectedDate
            );

            if (gunlukVeriler.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center p-4">Bu tarih için veri bulunamadı.</td></tr>';
                wrapper.classList.remove('hidden');
                return;
            }

            // Verileri derse göre grupla
            const dersGruplari = {};
            gunlukVeriler.forEach(soru => {
                const ders = soru.ders;
                if (!dersGruplari[ders]) {
                    dersGruplari[ders] = { dogru: 0, yanlis: 0 };
                }
                dersGruplari[ders].dogru += soru.dogru || 0;
                dersGruplari[ders].yanlis += soru.yanlis || 0;
            });
            
            // Tabloyu doldur
            Object.keys(dersGruplari).sort().forEach(ders => {
                const veri = dersGruplari[ders];
                const toplam = veri.dogru + veri.yanlis;
                const row = `
                    <tr>
                        <td class="font-medium text-white">${ders}</td>
                        <td class="text-green-400">${veri.dogru}</td>
                        <td class="text-red-400">${veri.yanlis}</td>
                        <td class="text-white">${toplam}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
            wrapper.classList.remove('hidden');
        }

        // --- 7. "HAFTALIK RAPOR" SEKME FONKSİYONLARI ---

        function setupWeeklyReport() {
            const haftaSelect = document.getElementById('haftaSelect');
            
            // Hafta seçiciyi doldur (Örn: Bu Hafta, Geçen Hafta...)
            const haftalar = getRecentWeeks(10); // Son 10 haftayı al
            haftalar.forEach((hafta, index) => {
                const option = document.createElement('option');
                option.value = hafta.start.toISOString(); // Haftanın başlangıcını (Pazartesi) değer olarak ata
                option.textContent = hafta.label;
                haftaSelect.appendChild(option);
            });

            // Hafta seçimi değiştiğinde grafiği ve tabloyu güncelle
            haftaSelect.addEventListener('change', () => updateHaftalikRaporTab(tumSorular));
            
            // Grafik için Chart.js nesnesini başlat
            const ctx = document.getElementById('haftalikChartCanvas').getContext('2d');
            haftalikChartInstance = new Chart(ctx, {
                type: 'line',
                data: { labels: dayNamesShort, datasets: [] },
                options: getChartOptions() // Ortak grafik seçenekleri
            });
        }
        
        function updateWeeklyChartAndTable(sorular) {
            const haftaSelect = document.getElementById('haftaSelect');
            if (!haftaSelect.value) return; // Hafta seçici henüz dolmadıysa çık
            
            const selectedWeekStart = new Date(haftaSelect.value);
            const selectedWeekEnd = new Date(selectedWeekStart);
            selectedWeekEnd.setDate(selectedWeekEnd.getDate() + 7); // Pzt'den sonraki Pzt

            // Verileri seçilen haftaya göre filtrele
            const haftalikVeriler = sorular.filter(s => 
                s.tarih >= selectedWeekStart && s.tarih < selectedWeekEnd
            );
            
            // 1. Grafik Verilerini Hazırla (Günlük Toplamlar)
            const gunlukToplamlar = new Array(7).fill(0); // Pzt-Paz
            
            // 2. Tablo Verilerini Hazırla (Ders-Gün Kırılımı)
            const tabloVerisi = {};
            allSubjects.forEach(ders => {
                // Her ders için 7 gün (Pzt-Paz) ve 1 toplam (son) sütunu
                tabloVerisi[ders] = new Array(8).fill(0); 
            });

            haftalikVeriler.forEach(soru => {
                const gunIndex = (soru.tarih.getDay() + 6) % 7; // 0=Pzt, 6=Paz
                const toplam = (soru.dogru || 0) + (soru.yanlis || 0);
                
                gunlukToplamlar[gunIndex] += toplam;
                
                if (tabloVerisi[soru.ders]) {
                    tabloVerisi[soru.ders][gunIndex] += toplam;
                    tabloVerisi[soru.ders][7] += toplam; // Haftalık Toplam sütunu
                }
            });

            // Grafiği Güncelle
            haftalikChartInstance.data.datasets = [{
                label: 'Toplam Soru',
                data: gunlukToplamlar,
                borderColor: '#a78bfa', // Mor çizgi
                backgroundColor: 'rgba(167, 139, 250, 0.2)',
                fill: true,
                tension: 0.3,
                pointBackgroundColor: '#fff',
                pointBorderColor: '#a78bfa',
                pointHoverRadius: 7
            }];
            haftalikChartInstance.update();

            // Tabloyu Güncelle
            const tbody = document.getElementById('haftalikDetayBody');
            tbody.innerHTML = ''; // Temizle
            
            allSubjects.forEach(ders => {
                const veriler = tabloVerisi[ders];
                const haftalikToplam = veriler[7];
                
                // Eğer o hafta dersten hiç soru çözülmemişse bile satırı '0' olarak göster
                const row = `
                    <tr class="text-white">
                        <td class="text-left font-medium">${ders}</td>
                        ${veriler.slice(0, 7).map(val => `<td>${val}</td>`).join('')}
                        <td class="font-bold text-purple-300">${haftalikToplam}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }
        
        // --- 8. "AYLIK RAPOR" SEKME FONKSİYONLARI ---

        function setupMonthlyReport() {
            const monthSelect = document.getElementById('month-select');
            
            // Ay seçiciyi doldur (Son 12 ay)
            const aylar = getRecentMonths(12);
            aylar.forEach(ay => {
                const option = document.createElement('option');
                option.value = ay.value; // Örn: "2025-10"
                option.textContent = ay.label; // Örn: "Ekim 2025"
                monthSelect.appendChild(option);
            });
            
            // Ay seçimi değiştiğinde güncelle
            monthSelect.addEventListener('change', () => updateAylikRaporTab(tumSorular));
            
            // Grafik için Chart.js nesnesini başlat
            const ctx = document.getElementById('monthly-chart-canvas').getContext('2d');
            aylikChartInstance = new Chart(ctx, {
                type: 'line',
                data: { labels: [], datasets: [] },
                options: getChartOptions() // Ortak grafik seçenekleri
            });
        }
        
        function updateMonthlyChartAndTable(sorular) {
            const monthSelect = document.getElementById('month-select');
            if (!monthSelect.value) return; // Ay seçici henüz dolmadıysa çık

            const [year, month] = monthSelect.value.split('-').map(Number); // Örn: [2025, 10]
            // Not: JavaScript'te aylar 0-11 arasıdır, bu yüzden ay'ı 1 azaltmalıyız
            const selectedMonthIndex = month - 1; 

            const startDate = new Date(year, selectedMonthIndex, 1);
            const endDate = new Date(year, selectedMonthIndex + 1, 1);
            
            // Verileri seçilen aya göre filtrele
            const aylikVeriler = sorular.filter(s => 
                s.tarih >= startDate && s.tarih < endDate
            );
            
            const daysInMonth = new Date(year, selectedMonthIndex + 1, 0).getDate();
            
            // 1. Grafik Verilerini Hazırla (Aydaki Günlük Toplamlar)
            const gunlukToplamlar = new Array(daysInMonth).fill(0);
            const gunEtiketleri = new Array(daysInMonth).fill(0).map((_, i) => i + 1); // [1, 2, 3... 31]

            // 2. Tablo Verilerini Hazırla (Derslerin Aylık Toplamı)
            const tabloVerisi = {};
            allSubjects.forEach(ders => {
                tabloVerisi[ders] = { dogru: 0, yanlis: 0, toplam: 0 };
            });

            aylikVeriler.forEach(soru => {
                const gunIndex = soru.tarih.getDate() - 1; // 1. gün -> index 0
                const dogru = soru.dogru || 0;
                const yanlis = soru.yanlis || 0;
                const toplam = dogru + yanlis;
                
                gunlukToplamlar[gunIndex] += toplam;
                
                if (tabloVerisi[soru.ders]) {
                    tabloVerisi[soru.ders].dogru += dogru;
                    tabloVerisi[soru.ders].yanlis += yanlis;
                    tabloVerisi[soru.ders].toplam += toplam;
                }
            });

            // Grafiği Güncelle
            aylikChartInstance.data.labels = gunEtiketleri;
            aylikChartInstance.data.datasets = [{
                label: 'Toplam Soru',
                data: gunlukToplamlar,
                borderColor: '#a78bfa',
                backgroundColor: 'rgba(167, 139, 250, 0.2)',
                fill: true,
                tension: 0.3
            }];
            aylikChartInstance.update();

            // Tabloyu Güncelle
            const tbody = document.getElementById('monthly-details-body');
            tbody.innerHTML = ''; // Temizle
            
            allSubjects.forEach(ders => {
                const veri = tabloVerisi[ders];
                const basari = (veri.toplam > 0) ? Math.round((veri.dogru / veri.toplam) * 100) : 0;
                
                const row = `
                    <tr class="text-white">
                        <td class="font-medium">${ders}</td>
                        <td>${veri.toplam}</td>
                        <td class="text-green-400">${veri.dogru}</td>
                        <td class="text-red-400">${veri.yanlis}</td>
                        <td class="font-semibold ${basari > 70 ? 'text-green-400' : (basari < 40 ? 'text-red-400' : '')}">${basari}%</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        // --- 9. YARDIMCI FONKSİYONLAR ---
        
        // Ortak Grafik (Chart.js) Seçenekleri
        function getChartOptions() {
            return {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { color: 'rgba(255, 255, 255, 0.1)' },
                        ticks: { 
                            color: '#d1d5db',
                            font: { weight: '600' }
                        }
                    },
                    x: {
                        grid: { color: 'rgba(255, 255, 255, 0.05)' },
                        ticks: { 
                            color: '#d1d5db',
                            font: { weight: '600' }
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false // Etiketi (label) gizle
                    },
                    tooltip: {
                        backgroundColor: '#1f2937',
                        titleColor: '#a78bfa',
                        bodyColor: '#ffffff',
                        titleFont: { weight: 'bold' },
                        bodyFont: { weight: '500' },
                        padding: 10,
                        cornerRadius: 8,
                        displayColors: false
                    }
                }
            };
        }
        
        // Haftanın başlangıcını (Pazartesi) alır
        function getStartOfWeek(date) {
            const d = new Date(date);
            const day = d.getDay(); // 0=Paz, 1=Pzt
            const diff = d.getDate() - day + (day === 0 ? -6 : 1); // Pazar ise 6 gün geri, değilse (Pazartesi 1) git
            d.setDate(diff);
            d.setHours(0, 0, 0, 0);
            return d;
        }

        // Hafta seçici için liste oluşturur
        function getRecentWeeks(count) {
            let weeks = [];
            let currentDate = new Date();
            
            for (let i = 0; i < count; i++) {
                const weekStart = getStartOfWeek(currentDate);
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekEnd.getDate() + 6);
                
                let label = "";
                if (i === 0) label = "Bu Hafta";
                else if (i === 1) label = "Geçen Hafta";
                else label = `${weekStart.toLocaleDateString('tr-TR')} - ${weekEnd.toLocaleDateString('tr-TR')}`;
                
                weeks.push({ label: label, start: weekStart });
                
                // Bir önceki haftaya git
                currentDate.setDate(currentDate.getDate() - 7);
            }
            return weeks;
        }
        
        // Ay seçici için liste oluşturur
        function getRecentMonths(count) {
            let months = [];
            let currentDate = new Date();
            
            for (let i = 0; i < count; i++) {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth(); // 0-11
                
                const label = `${monthNames[month]} ${year}`;
                const value = `${year}-${String(month + 1).padStart(2, '0')}`; // "2025-10"
                
                months.push({ label, value });
                
                // Bir önceki aya git
                currentDate.setMonth(currentDate.getMonth() - 1);
            }
            return months;
        }

    </script>
</body>
</html>


