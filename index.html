<!DOCTYPE html>

<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Soru Takip Programı - Giriş ve Panel</title>
<script src="https://cdn.tailwindcss.com">
// --- Mesaj (✉️) butonu: placeholder ---
document.getElementById('tsr-envelope-btn')?.addEventListener('click', () => {
  try { showNotification('Mesaj butonu: işlev yakında eklenecek.', 'info'); }
  catch (e) { console.log('Mesaj butonu tıklandı.'); }
});

</script>
<script src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js" type="module"></script>
<script nomodule="" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
<style>
        /* Ana gövde için Inter fontunu varsayılan yap */
        body {
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
        }

        /* Sekmeler ve Paneller için temel gizleme/gösterme */
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .panel-tab-content { display: none; }
        .panel-tab-content.active { display: block; }

        /* Koyu tema için özel input stili */
        .dark-input {
            background-color: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            transition: background-color 0.3s, border-color 0.3s;
        }
        .dark-input::placeholder { color: rgba(255, 255, 255, 0.5); }
        .dark-input:focus {
            outline: none;
            background-color: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.4);
            box-shadow: 0 0 0 2px rgba(168, 85, 247, 0.5);
        }
        .dark-input option, .dark-input::-webkit-calendar-picker-indicator {
            color: #000;
            filter: invert(1);
        }

        /* Bildirim Kutusu Stili */
        #notification-box {
            position: fixed; top: 1rem; right: 1rem; z-index: 1000;
            min-width: 250px; max-width: 90%; pointer-events: none;
        }

        /* Tablo ve Takvim Stilleri (Panel İçin) */
        .table-container::-webkit-scrollbar { width: 8px; height: 8px; }
        .table-container::-webkit-scrollbar-thumb { background-color: rgba(168, 85, 247, 0.6); border-radius: 10px; }
        .table-container::-webkit-scrollbar-track { background-color: rgba(255, 255, 255, 0.1); border-radius: 10px; }
        
        .day-cell { position: relative; padding-top: 100%; cursor: pointer; transition: background-color 0.2s; height: 0; }
        .day-cell-content { position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; align-items: center; justify-content: center; border-radius: 0.5rem; border: 2px solid transparent; }
        .day-cell.other-month .day-cell-content { opacity: 0.2; pointer-events: none; }
        .day-cell:not(.other-month):hover .day-cell-content { background-color: rgba(255, 255, 255, 0.1); }
        .day-cell.selected .day-cell-content { border-color: rgba(168, 85, 247, 0.9); color: white; font-weight: bold; }
        .day-cell.has-entry .day-cell-content::after {
            content: ''; position: absolute; bottom: 4px; left: 50%; transform: translateX(-50%);
            width: 5px; height: 5px; background-color: #F87171; border-radius: 50%;
        }

        /* Veli Paneli Modal Stilleri */
        .modal-backdrop {
            display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto;
            background-color: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); animation: fadeIn 0.3s ease-out;
        }
        .modal-content {
            background-color: rgba(22, 18, 38, 0.8); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2); color: white; margin: 10% auto; padding: 24px; border-radius: 16px; 
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3); width: 90%; max-width: 600px; animation: slideIn 0.3s ease-out;
        }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .animate-spin-fast { animation: spin 0.8s linear infinite; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-30px); } to { opacity: 1; transform: translateY(0); } }

    

/* === Öğretmen paneli (güncel) ek CSS === */
#studentDetailModal .modal-content {
  margin: 5% auto;
  max-width: 1152px; /* 6xl karşılığı */
  background-color: rgba(10, 8, 20, 0.9);
}
.student-detail-trigger {
  background: none; border: none; padding: 0; margin: 0;
  font-weight: 500; text-align: left; transition: color 0.2s; color: #e5e7eb;
}
.student-detail-trigger:hover { color: #c084fc; }
.favorite-star { background: none; border: none; padding: 4px; transition: all .2s ease-out; cursor: pointer; }
.favorite-star.favorited ion-icon { color: #facc15; }
.student-detail-tab-content { display: none; }
.student-detail-tab-content.active { display: block; }
</style>

<!-- PATCH: Favori yıldız rengi ve tıklama animasyonu (öğretmen paneli → sınıf öğrenci listesi) -->
<style id="favorite-star-patch">
/* Yalnızca sınıf listesinin açıldığı öğrenci listesi modalını hedefle */
#studentListModal .favorite-star{
  background: none;
  border: none;
  padding: 4px;
  cursor: pointer;
  line-height: 1;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  transition: transform 0.18s ease-out;
}

/* İkon her iki durumda da sarı; outline ise sarı çizgi, favorited ise içi dolu sarı */
#studentListModal .favorite-star ion-icon{
  color: #facc15; /* tailwind yellow-400 */
  transition: color 0.18s ease-out;
  font-size: 1.25rem; /* mevcut düzeni bozmadan okunaklılık */
  vertical-align: middle;
}

/* Tıklamada büyü-küçül animasyonu */
#studentListModal .favorite-star.pop-animation{
  animation: star-pop 0.24s ease-out;
  transform-origin: center;
}

@keyframes star-pop{
  0%   { transform: scale(1); }
  55%  { transform: scale(1.25); }
  100% { transform: scale(1); }
}
</style>

<style id="student-list-modal-purple-gradient">
  /* Öğretmen paneli → Öğrenci Listesi modalının arka planını mor degrade yap */
  #studentListModal .modal-content {
    background: linear-gradient(135deg,
      rgba(109, 40, 217, 0.92) 0%,
      rgba(139, 92, 246, 0.90) 45%,
      rgba(167, 139, 250, 0.88) 100%
    ) !important;
    color: #fff;
    border-color: rgba(255, 255, 255, 0.2);
  }
  /* (Opsiyonel) Modal içindeki çok açık beyaz overlay sınıfları varsa biraz yumuşat */
  #studentListModal .modal-content .bg-white.bg-opacity-5{ background-color: rgba(255,255,255,0.08); }
</style>

<style id="student-list-modal-purple-gradient-v2">
  /* Öğrenci Listesi modalı: referans görseldeki daha koyu mor ton */
  #studentListModal .modal-content {
    /* Hafif varyanslı degrade: #411d6e → #4d2281 → #55258e */
    background: linear-gradient(135deg, #411d6e 0%, #4d2281 50%, #55258e 100%) !important;
    color: #fff;
    border-color: rgba(255,255,255,0.18);
  }
  /* İç overlay'leri koyu tonda görünür kılmak için ufak ayar (opsiyonel) */
  #studentListModal .modal-content .bg-white, 
  #studentListModal .modal-content .bg-gray-50 {
    background-color: rgba(255,255,255,0.06) !important;
  }
</style>





<style id="report-tab-container-gradient">
  /* Rapor sekmesi kök kapsayıcılarının (panel-tab-content) arka planını da mor degrade yap */
  #student-panel .panel-tab-content#gunluk-rapor,
  #student-panel .panel-tab-content#haftalik-rapor,
  #student-panel .panel-tab-content#aylik-rapor {
    background: linear-gradient(135deg, #411d6e 0%, #4d2281 50%, #55258e 100%) !important;
    background-color: transparent !important;
  }
</style>

<style id="studentDetailModal-purple">
  /* Öğrenci ismi tıklanınca açılan rapor modalı */
  #studentDetailModal .modal-content {
    background: linear-gradient(135deg, #411d6e 0%, #4d2281 50%, #55258e 100%) !important;
    color: #fff;
    border-color: rgba(255,255,255,0.20) !important;
  }
  /* Modal içindeki rapor sekmelerinin kökleri de degrade olsun */
  #studentDetailModal .panel-tab-content#gunluk-rapor,
  #studentDetailModal .panel-tab-content#haftalik-rapor,
  #studentDetailModal .panel-tab-content#aylik-rapor {
    background: linear-gradient(135deg, #411d6e 0%, #4d2281 50%, #55258e 100%) !important;
  }
  /* O sekmeler içindeki eski siyah kartlar */
  #studentDetailModal .panel-tab-content#gunluk-rapor [class*="bg-black"],
  #studentDetailModal .panel-tab-content#haftalik-rapor [class*="bg-black"],
  #studentDetailModal .panel-tab-content#aylik-rapor [class*="bg-black"] {
    background: linear-gradient(135deg, #411d6e 0%, #4d2281 50%, #55258e 100%) !important;
    background-color: transparent !important;
  }
</style>

<style id="studentDetailModal-home-backdrop">
  /* Öğrenci rapor modali arka planı: anasayfadaki gradient ile aynı */
  #studentDetailModal {
    background: linear-gradient(135deg, #3730a3 0%, #6b21a8 50%, #312e81 100%) !important;
    background-color: transparent !important; /* rgba(0,0,0,.6) overlay'i sıfırla */
  }
</style>

<style id="no-spin-and-ghost-zero">
/* Sadece Doğru/Yanlış alanları için number spinnerlarını kaldır */
#dogru, #yanlis { -moz-appearance: textfield; }
#dogru::-webkit-outer-spin-button,
#dogru::-webkit-inner-spin-button,
#yanlis::-webkit-outer-spin-button,
#yanlis::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
/* Odak alındığında (tıklanınca) placeholder '0' görünmesin */
#dogru:focus::placeholder, #yanlis:focus::placeholder { color: transparent; }
</style>

<style id="topbar-gradient-patch">
  /* Üst şerit (öğretmen/öğrenci nav) mor gradyan */
  #teacher-panel > nav,
  #student-panel > nav {
    background: linear-gradient(90deg, #2F2A82 0%, #412683 50%, #532286 100%) !important;
    border: none !important;
    box-shadow: none !important;
  }
  /* Çıkış butonunun tonu */
  #teacher-logout-button, #student-logout-button {
    background-color: #E53935 !important;
  }
  #teacher-logout-button:hover, #student-logout-button:hover {
    background-color: #D32F2F !important;
  }
</style>
<style>
/* --- injected fix for overflow in teacher stats --- */
#teacher-stat-daily, #teacher-stat-weekly, #teacher-stat-monthly {
  display: block;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  max-width: 100%;
}
</style>

<!-- MOBILE RESPONSIVENESS PATCH START -->
<meta name="theme-color" content="#4d2281">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<style id="mobile-responsiveness-patch">
  /* Use dynamic viewport units on modern mobile browsers */
  @supports (height: 100dvh) {
    body { min-height: 100dvh; }
  }
  :root {
    --safe-top: env(safe-area-inset-top);
    --safe-bottom: env(safe-area-inset-bottom);
  }
  body { padding-bottom: max(var(--safe-bottom), 0px); }

  /* Improve touch targets */
  button, [role="button"], .tab-button,
  .student-panel-tab-button, .parent-panel-tab-button,
  .teacher-panel-tab-button, .panel-tab-button {
    min-height: 44px;
    touch-action: manipulation;
  }

  /* Compact spacing on mobile */
  @media (max-width: 640px) {
    /* Nav title shrink + ellipsis */
    #student-panel nav span.text-xl,
    #parent-panel nav span.text-xl,
    #teacher-panel nav span.text-xl,
    #teacher-panel nav span.font-bold,
    #student-panel nav span.font-bold,
    #parent-panel nav span.font-bold {
      font-size: 1rem !important;
      max-width: 62vw;
      display: inline-block;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Reduce paddings to fit small screens */
    .p-6 { padding: 1rem !important; }
    .p-5 { padding: 0.875rem !important; }
    .p-4 { padding: 0.75rem !important; }
    .mb-6 { margin-bottom: 1rem !important; }

    /* Calendars: tighter grid + smaller day font */
    #student-calendar-grid, #parent-calendar-grid, #tsr-calendar-grid {
      gap: 2px !important;
    }
    .day-cell-content { font-size: 0.75rem; }

    /* Tables: allow full fluid width and tighter cells */
    .table-container table {
      min-width: 0 !important;
      width: 100% !important;
      table-layout: auto !important;
      word-break: break-word;
    }
    .table-container th, .table-container td {
      padding: 0.5rem 0.5rem !important;
      font-size: 0.8rem !important;
    }

    /* Modals: nearly full-width with comfortable padding */
    .modal-content {
      width: 96% !important;
      margin: 10% auto !important;
      padding: 1rem !important;
      border-radius: 14px !important;
    }

    /* Charts: limit vertical space on small screens */
    canvas { max-height: 260px; }
  }

  @media (max-width: 380px) {
    .day-cell-content { font-size: 0.65rem; }
  }
</style>
<!-- MOBILE RESPONSIVENESS PATCH END -->

</head>
<body class="bg-gradient-to-br from-indigo-800 via-purple-800 to-indigo-900 text-white min-h-screen">
<div class="space-y-2" id="notification-box"></div>
<div class="flex min-h-screen items-center justify-center p-4" id="auth-page">
<div class="w-full max-w-lg bg-black bg-opacity-20 backdrop-blur-lg rounded-2xl shadow-2xl p-6 sm:p-8 border border-white border-opacity-20">
<div class="flex flex-col items-center mb-6">
<div class="mb-4 bg-white bg-opacity-10 p-3 rounded-full">
<svg class="w-12 h-12 text-purple-400" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
<path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
</svg>
</div>
<h1 class="text-2xl font-bold text-center text-white shadow-sm">SORU TAKİP PROGRAMI</h1>
<p class="text-lg font-medium text-gray-300 mt-1">YAVUZ SELİM ORTAOKULU</p>
</div>
<div class="flex flex-wrap justify-between gap-2 bg-black bg-opacity-20 rounded-lg p-1 mb-6">
<button class="tab-button flex-auto text-sm font-medium py-2 px-3 rounded-md" data-tab="kayit">Kayıt Ol</button>
<button class="tab-button flex-auto text-sm font-medium py-2 px-3 rounded-md" data-tab="ogrenci-giris">Öğrenci Giriş</button>
<button class="tab-button flex-auto text-sm font-medium py-2 px-3 rounded-md" data-tab="veli-giris">Veli Giriş</button>
<button class="tab-button flex-auto text-sm font-medium py-2 px-3 rounded-md" data-tab="ogretmen-giris">Öğretmen Giriş</button>
</div>
<div class="tab-content" id="kayit">
<h2 class="text-xl font-semibold mb-4 text-center text-gray-200">Yeni Hesap Oluştur</h2>
<div class="mb-5">
<label class="block text-sm font-medium text-gray-300 mb-1" for="role-select">Kayıt Tipi:</label>
<select class="w-full p-2.5 rounded-lg dark-input" id="role-select">
<option style="color: #000;" value="ogrenci">Öğrenci</option>
<option style="color: #000;" value="veli">Veli</option>
</select>
</div>
<div id="ogrenci-form">
<form class="space-y-4" id="ogrenci-register-form">
<input class="w-full p-2.5 rounded-lg dark-input" id="reg-ogrenci-no" placeholder="Öğrenci No (Örn: 101)" required="" type="text"/>
<input class="w-full p-2.5 rounded-lg dark-input" id="reg-ad" placeholder="Ad" required="" type="text"/>
<input class="w-full p-2.5 rounded-lg dark-input" id="reg-soyad" placeholder="Soyad" required="" type="text"/>
<select class="w-full p-2.5 rounded-lg dark-input" id="sinif-select-register" required="">
<option style="color: #000;" value="">Sınıfınızı Seçin...</option>
<option style="color: #000;" value="5-A">5-A</option>
<option style="color: #000;" value="5-B">5-B</option>
<option style="color: #000;" value="8-C">8-C</option>
</select>
<input class="w-full p-2.5 rounded-lg dark-input" id="reg-sifre" placeholder="Şifre" required="" type="password"/>
<input class="w-full p-2.5 rounded-lg dark-input" id="reg-sifre-tekrar" placeholder="Şifre Tekrar" required="" type="password"/>
<button class="w-full bg-purple-600 text-white py-3 px-4 rounded-lg hover:bg-purple-700 font-medium transition duration-150 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 focus:ring-offset-purple-900" type="submit">
                            Kayıt Ol
                        </button>
</form>
</div>
<div class="hidden" id="veli-form">
<form class="space-y-4" id="veli-register-form">
<input class="w-full p-2.5 rounded-lg dark-input" id="veli-reg-ad" placeholder="Ad" required="" type="text"/>
<input class="w-full p-2.5 rounded-lg dark-input" id="veli-reg-soyad" placeholder="Soyad" required="" type="text"/>
<input class="w-full p-2.5 rounded-lg dark-input" id="veli-reg-ogrenci-no" placeholder="Çocuğunuzun Öğrenci No" required="" type="text"/>
<input class="w-full p-2.5 rounded-lg dark-input" id="veli-reg-sifre" placeholder="Şifre" required="" type="password"/>
<input class="w-full p-2.5 rounded-lg dark-input" id="veli-reg-sifre-tekrar" placeholder="Şifre Tekrar" required="" type="password"/>
<button class="w-full bg-purple-600 text-white py-3 px-4 rounded-lg hover:bg-purple-700 font-medium transition duration-150 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 focus:ring-offset-purple-900" type="submit">
                            Kayıt Ol
                        </button>
</form>
</div>
</div>
<div class="tab-content" id="ogrenci-giris">
<h2 class="text-xl font-semibold mb-4 text-center text-gray-200">Öğrenci Girişi</h2>
<form class="space-y-4" id="ogrenci-login-form">
<input class="w-full p-2.5 rounded-lg dark-input" id="login-ogrenci-no" placeholder="Öğrenci No" required="" type="text"/>
<input class="w-full p-2.5 rounded-lg dark-input" id="login-sifre" placeholder="Şifre" required="" type="password"/>
<div class="flex items-center justify-center">
<input class="h-4 w-4 rounded text-purple-500 bg-transparent border-gray-400 focus:ring-purple-500" id="remember-ogrenci" type="checkbox"/>
<label class="ml-2 block text-sm text-gray-300" for="remember-ogrenci">Beni Hatırla</label>
</div>
<button class="w-full bg-purple-600 text-white py-3 px-4 rounded-lg hover:bg-purple-700 font-medium transition duration-150 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 focus:ring-offset-purple-900" type="submit">
                        Giriş Yap
                    </button>
</form>
</div>
<div class="tab-content" id="veli-giris">
<h2 class="text-xl font-semibold mb-4 text-center text-gray-200">Veli Girişi</h2>
<form class="space-y-4" id="veli-login-form">
<input class="w-full p-2.5 rounded-lg dark-input" id="veli-login-ogrenci-no" placeholder="Çocuğunuzun Öğrenci No" required="" type="text"/>
<input class="w-full p-2.5 rounded-lg dark-input" id="veli-login-sifre" placeholder="Şifre" required="" type="password"/>
<div class="flex items-center justify-center">
<input class="h-4 w-4 rounded text-purple-500 bg-transparent border-gray-400 focus:ring-purple-500" id="remember-veli" type="checkbox"/>
<label class="ml-2 block text-sm text-gray-300" for="remember-veli">Beni Hatırla</label>
</div>
<button class="w-full bg-purple-600 text-white py-3 px-4 rounded-lg hover:bg-purple-700 font-medium transition duration-150 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 focus:ring-offset-purple-900" type="submit">
                        Giriş Yap
                    </button>
</form>
</div>
<div class="tab-content" id="ogretmen-giris">
<h2 class="text-xl font-semibold mb-4 text-center text-gray-200">Öğretmen Girişi</h2>
<form class="space-y-4" id="ogretmen-login-form">
<input class="w-full p-2.5 rounded-lg dark-input" id="ogretmen-login-ad" placeholder="Öğretmen Adı (Örn: Ahmet Yılmaz)" required="" type="text"/>
<input class="w-full p-2.5 rounded-lg dark-input" id="ogretmen-login-kod" placeholder="Şifre/Kod" required="" type="password"/>
<div class="flex items-center justify-center">
<input class="h-4 w-4 rounded text-purple-500 bg-transparent border-gray-400 focus:ring-purple-500" id="remember-ogretmen" type="checkbox"/>
<label class="ml-2 block text-sm text-gray-300" for="remember-ogretmen">Beni Hatırla</label>
</div>
<button class="w-full bg-purple-600 text-white py-3 px-4 rounded-lg hover:bg-purple-700 font-medium transition duration-150 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 focus:ring-offset-purple-900" type="submit">
                        Giriş Yap
                    </button>
</form>
</div>
</div>
</div>
<div class="hidden" id="student-panel">
<nav class="bg-black bg-opacity-20 backdrop-blur-lg sticky top-0 z-50 border-b border-white border-opacity-20">
<div class="container mx-auto px-4 sm:px-6 lg:px-8">
<div class="flex justify-between items-center h-16">
<div class="flex items-center space-x-3">
<div class="bg-white bg-opacity-10 p-2 rounded-full">
<svg class="w-6 h-6 text-purple-400" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
<path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
</svg>
</div>
<span class="text-xl font-bold text-white">YAVUZ SELİM ORTAOKULU (ÖĞRENCİ)</span>
</div>
<div class="flex items-center space-x-4">
<span class="hidden sm:block text-sm text-gray-300">Hoş Geldin, <span class="font-medium text-white" id="welcome-user-name">Kullanıcı Adı</span></span>
<button class="bg-purple-600 text-white py-2 px-4 rounded-lg hover:bg-purple-700 font-medium transition duration-150 text-sm focus:outline-none focus:ring-2 focus:ring-purple-500" id="student-logout-button">
                            Çıkış Yap
                        </button>
</div>
</div>
</div>
</nav>
<div class="container mx-auto p-4 sm:p-6 lg:p-8">
<div class="flex flex-wrap gap-2 bg-black bg-opacity-20 border border-white border-opacity-20 rounded-lg p-1 mb-6 max-w-xl">
<button class="student-panel-tab-button flex-auto text-sm font-medium py-2 px-3 rounded-md" data-tab="soru-girisi">Soru Girişi</button>
<button class="student-panel-tab-button flex-auto text-sm font-medium py-2 px-3 rounded-md" data-tab="gunluk-rapor">Günlük Rapor</button>
<button class="student-panel-tab-button flex-auto text-sm font-medium py-2 px-3 rounded-md" data-tab="haftalik-rapor">Haftalık Rapor</button>
<button class="student-panel-tab-button flex-auto text-sm font-medium py-2 px-3 rounded-md" data-tab="aylik-rapor">Aylık Rapor</button>
</div>
<div>
<div class="panel-tab-content" id="soru-girisi">
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
<div class="lg:col-span-1">
<div class="bg-black bg-opacity-20 backdrop-blur-lg rounded-2xl shadow-2xl p-6 border border-white border-opacity-20">
<h2 class="text-2xl font-bold mb-5 text-purple-300">Soru Ekle</h2>
<form class="space-y-4" id="soru-giris-form">
<div>
<label class="block text-sm font-medium text-gray-300 mb-1" for="ders">Ders</label>
<select class="w-full p-2.5 rounded-lg dark-input" id="ders">
<option style="color: #000;" value="">Ders Seçin...</option>
<option style="color: #000;" value="Matematik">Matematik</option>
<option style="color: #000;" value="Türkçe">Türkçe</option>
<option style="color: #000;" value="Fen Bilimleri">Fen Bilimleri</option>
<option style="color: #000;" value="Sosyal Bilgiler">Sosyal Bilgiler</option>
<option style="color: #000;" value="İngilizce">İngilizce</option>
<option style="color: #000;" value="Din Kültürü">Din Kültürü</option>
</select>
</div>
<div class="grid grid-cols-2 gap-3">
<div>
<label class="block text-sm font-medium text-gray-300 mb-1" for="dogru">Doğru</label>
<input class="w-full p-2.5 rounded-lg dark-input text-center" id="dogru" min="0" placeholder="0" type="number"/>
</div>
<div>
<label class="block text-sm font-medium text-gray-300 mb-1" for="yanlis">Yanlış</label>
<input class="w-full p-2.5 rounded-lg dark-input text-center" id="yanlis" min="0" placeholder="0" type="number"/>
</div>
</div>
<button class="w-full bg-purple-600 text-white py-3 px-4 rounded-lg hover:bg-purple-700 font-medium transition duration-150 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 focus:ring-offset-purple-900" type="submit">
                                        Kaydet
                                    </button>
</form>
</div>
</div>
<div class="lg:col-span-2 space-y-6">
<div class="grid grid-cols-1 md:grid-cols-3 gap-4">
<div class="bg-black bg-opacity-20 backdrop-blur-lg rounded-2xl p-5 border border-white border-opacity-20 text-center">
<h3 class="text-sm font-medium text-gray-300 uppercase">Bugün Çözülen</h3>
<p class="text-4xl font-bold text-white mt-2" id="stat-bugun">0</p>
</div>
<div class="bg-black bg-opacity-20 backdrop-blur-lg rounded-2xl p-5 border border-white border-opacity-20 text-center">
<h3 class="text-sm font-medium text-gray-300 uppercase">Haftalık Toplam</h3>
<p class="text-4xl font-bold text-white mt-2" id="stat-haftalik">0</p>
</div>
<div class="bg-black bg-opacity-20 backdrop-blur-lg rounded-2xl p-5 border border-white border-opacity-20 text-center">
<h3 class="text-sm font-medium text-gray-300 uppercase">Genel Başarı</h3>
<p class="text-4xl font-bold text-purple-400 mt-2" id="stat-basari">-%</p>
</div>
</div>
<div class="bg-black bg-opacity-20 backdrop-blur-lg rounded-2xl shadow-2xl p-6 border border-white border-opacity-20">
<h2 class="text-2xl font-bold mb-5 text-purple-300" id="today-entries-title">Son Eklenenler</h2>
<div class="overflow-x-auto table-container">
<table class="w-full min-w-[400px] text-left">
<thead class="border-b border-white border-opacity-30">
<tr>
<th class="py-2 px-3 text-sm font-semibold uppercase text-gray-300">Ders</th>
<th class="py-2 px-3 text-sm font-semibold uppercase text-gray-300 text-center">D</th>
<th class="py-2 px-3 text-sm font-semibold uppercase text-gray-300 text-center">Y</th>
<th class="py-2 px-3 text-sm font-semibold uppercase text-gray-300 text-center">Toplam</th>
</tr>
</thead>
<tbody class="divide-y divide-white divide-opacity-10" id="son-eklenenler-body">
<tr><td class="py-3 px-3 text-center text-gray-400" colspan="4">Henüz veri yok.</td></tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="panel-tab-content" id="gunluk-rapor">
<div class="bg-transparent bg-opacity-20 backdrop-blur-lg rounded-2xl shadow-2xl p-6 border border-white border-opacity-20" style="background: linear-gradient(135deg, #411d6e 0%, #4d2281 50%, #55258e 100%) !important;">
<h2 class="text-2xl font-bold mb-5 text-purple-300">Günlük Rapor</h2>
<div class="flex justify-between items-center mb-4">
<button class="p-2 rounded-full hover:bg-white hover:bg-opacity-10 transition focus:outline-none focus:ring-2 focus:ring-purple-500" id="student-prev-month">
<svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M15 19l-7-7 7-7" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg>
</button>
<h3 class="text-xl font-semibold" id="student-month-year"></h3>
<button class="p-2 rounded-full hover:bg-white hover:bg-opacity-10 transition focus:outline-none focus:ring-2 focus:ring-purple-500" id="student-next-month">
<svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M9 5l7 7-7 7" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg>
</button>
</div>
<div class="grid grid-cols-7 gap-1 text-center mb-2">
<span class="text-xs font-bold text-purple-300 uppercase">PZT</span>
<span class="text-xs font-bold text-purple-300 uppercase">SAL</span>
<span class="text-xs font-bold text-purple-300 uppercase">ÇAR</span>
<span class="text-xs font-bold text-purple-300 uppercase">PER</span>
<span class="text-xs font-bold text-purple-300 uppercase">CUM</span>
<span class="text-xs font-bold text-purple-300 uppercase">CMT</span>
<span class="text-xs font-bold text-purple-300 uppercase">PAZ</span>
</div>
<div class="grid grid-cols-7 gap-1" id="student-calendar-grid">
</div>
<div class="mt-8 hidden" id="student-daily-details">
<h3 class="text-lg font-semibold text-purple-300 mb-4" id="student-details-title">Seçilen Günün Detayları</h3>
<div class="overflow-x-auto table-container">
<table class="w-full min-w-[400px] text-left">
<thead class="border-b border-white border-opacity-30">
<tr>
<th class="py-2 px-3 text-sm font-semibold uppercase text-gray-300">Ders</th>
<th class="py-2 px-3 text-sm font-semibold uppercase text-gray-300 text-center">D</th>
<th class="py-2 px-3 text-sm font-semibold uppercase text-gray-300 text-center">Y</th>
<th class="py-2 px-3 text-sm font-semibold uppercase text-gray-300 text-center">Toplam</th>
</tr>
</thead>
<tbody class="divide-y divide-white divide-opacity-10" id="student-details-table-body">
<tr><td class="py-3 px-3 text-center text-gray-400" colspan="4">Veri bulunamadı.</td></tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
<div class="panel-tab-content" id="haftalik-rapor">
<div class="space-y-6">
<div class="bg-transparent bg-opacity-20 backdrop-blur-lg rounded-2xl shadow-2xl p-6 border border-white border-opacity-20 flex flex-col sm:flex-row justify-between sm:items-center gap-4" style="background: linear-gradient(135deg, #411d6e 0%, #4d2281 50%, #55258e 100%) !important;">
<h2 class="text-2xl font-bold text-purple-300">Haftalık Rapor</h2>
<div class="flex items-center space-x-2 shrink-0">
<label class="text-sm font-medium text-gray-300" for="student-week-select">Hafta:</label>
<select class="p-2 rounded-lg dark-input text-sm" id="student-week-select"></select>
</div>
</div>
<div class="bg-transparent bg-opacity-20 backdrop-blur-lg rounded-2xl shadow-2xl p-6 border border-white border-opacity-20" style="background: linear-gradient(135deg, #411d6e 0%, #4d2281 50%, #55258e 100%) !important;">
<h3 class="text-lg font-semibold mb-4 text-purple-300">Haftalık Toplam Soru (Günlük)</h3>
<div class="h-64 md:h-80">
<canvas id="student-weekly-chart-canvas"></canvas>
</div>
</div>
<div class="bg-transparent bg-opacity-20 backdrop-blur-lg rounded-2xl shadow-2xl p-6 border border-white border-opacity-20" style="background: linear-gradient(135deg, #411d6e 0%, #4d2281 50%, #55258e 100%) !important;">
<h3 class="text-lg font-semibold mb-4 text-purple-300">Derslere Göre Haftalık Döküm (Toplam Soru)</h3>
<div class="overflow-x-auto table-container">
<table class="w-full text-left">
<thead class="border-b border-white border-opacity-30">
<tr>
<th class="py-2 px-3 text-xs font-semibold uppercase text-gray-300 sticky left-0 z-10" style="background-color: rgba(0,0,0,0.2); backdrop-filter: blur(10px);">Ders</th>
<th class="py-2 px-3 text-xs font-semibold uppercase text-gray-300 text-center">Pzt</th>
<th class="py-2 px-3 text-xs font-semibold uppercase text-gray-300 text-center">Sal</th>
<th class="py-2 px-3 text-xs font-semibold uppercase text-gray-300 text-center">Çar</th>
<th class="py-2 px-3 text-xs font-semibold uppercase text-gray-300 text-center">Per</th>
<th class="py-2 px-3 text-xs font-semibold uppercase text-gray-300 text-center">Cum</th>
<th class="py-2 px-3 text-xs font-semibold uppercase text-gray-300 text-center">Cmt</th>
<th class="py-2 px-3 text-xs font-semibold uppercase text-gray-300 text-center">Paz</th>
<th class="py-2 px-3 text-xs font-semibold uppercase text-gray-300 text-center">Top</th>
</tr>
</thead>
<tbody class="divide-y divide-white divide-opacity-10" id="student-weekly-details-body">
</tbody>
</table>
</div>
</div>
</div>
</div>
<div class="panel-tab-content" id="aylik-rapor">
<div class="space-y-6">
<div class="bg-transparent bg-opacity-20 backdrop-blur-lg rounded-2xl shadow-2xl p-6 border border-white border-opacity-20 flex flex-col sm:flex-row justify-between sm:items-center gap-4" style="background: linear-gradient(135deg, #411d6e 0%, #4d2281 50%, #55258e 100%) !important;">
<h2 class="text-2xl font-bold text-purple-300">Aylık Rapor</h2>
<div class="flex items-center space-x-2 shrink-0">
<label class="text-sm font-medium text-gray-300" for="student-month-select">Ay:</label>
<input class="p-2 rounded-lg dark-input text-sm" id="student-month-select" type="month"/>
</div>
</div>
<div class="bg-transparent bg-opacity-20 backdrop-blur-lg rounded-2xl shadow-2xl p-6 border border-white border-opacity-20" style="background: linear-gradient(135deg, #411d6e 0%, #4d2281 50%, #55258e 100%) !important;">
<h3 class="text-lg font-semibold mb-4 text-purple-300">Derslere Göre Toplam Soru Sayısı</h3>
<div class="h-64 md:h-80">
<canvas id="student-monthly-chart-canvas"></canvas>
</div>
</div>
<div class="bg-transparent bg-opacity-20 backdrop-blur-lg rounded-2xl shadow-2xl p-6 border border-white border-opacity-20" style="background: linear-gradient(135deg, #411d6e 0%, #4d2281 50%, #55258e 100%) !important;">
<h3 class="text-lg font-semibold mb-4 text-purple-300">Aylık Ders Dökümü</h3>
<div class="overflow-x-auto table-container">
<table class="w-full min-w-[500px] text-left">
<thead class="border-b border-white border-opacity-30">
<tr>
<th class="py-2 px-3 text-sm font-semibold uppercase text-gray-300">Ders</th>
<th class="py-2 px-3 text-sm font-semibold uppercase text-gray-300 text-center">Toplam Soru</th>
<th class="py-2 px-3 text-sm font-semibold uppercase text-gray-300 text-center">Doğru</th>
<th class="py-2 px-3 text-sm font-semibold uppercase text-gray-300 text-center">Yanlış</th>
<th class="py-2 px-3 text-sm font-semibold uppercase text-gray-300 text-center">Başarı</th>
</tr>
</thead>
<tbody class="divide-y divide-white divide-opacity-10" id="student-monthly-details-body">
<tr><td class="py-3 px-3 text-center text-gray-400" colspan="5">Veri yükleniyor...</td></tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="hidden" id="parent-panel">
<nav class="bg-transparent bg-opacity-20 backdrop-blur-lg shadow-lg border-b border-white border-opacity-10 sticky top-0 z-50" style="background: linear-gradient(135deg, #411d6e 0%, #4d2281 50%, #55258e 100%) !important;">
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
<div class="flex items-center justify-between h-16">
<div class="flex items-center space-x-3">
<div class="bg-white bg-opacity-10 p-2 rounded-full">
<svg class="w-6 h-6 text-purple-400" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
<path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
</svg>
</div>
<span class="text-xl font-bold text-white">YAVUZ SELİM ORTAOKULU (VELİ)</span>
</div>
<div class="flex items-center space-x-4">
<div class="text-right text-sm">
<div class="font-medium text-white" id="parent-welcome-veli-name">Veli: Ad Soyad</div>
<div class="text-gray-300" id="parent-welcome-student-info">Öğrenci: Mehmet (000)</div>
</div>
<button class="bg-red-600 hover:bg-red-700 text-white text-sm font-medium py-2 px-3 rounded-lg transition duration-150 flex items-center space-x-1" id="parent-logout-button">
<ion-icon class="text-lg" name="log-out-outline"></ion-icon>
<span>Çıkış Yap</span>
</button>
</div>
</div>
</div>
</nav>
<main class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
<div class="mb-6">
<h1 class="text-3xl font-bold text-white shadow-sm">Öğrenci Gelişim Özeti</h1>
<p class="text-lg text-gray-300" id="parent-student-summary-title">Öğrenci Bilgisi yükleniyor...</p>
</div>
<div class="flex flex-wrap gap-2 bg-transparent bg-opacity-20 border border-white border-opacity-20 rounded-lg p-1 mb-6 max-w-xl" style="background: linear-gradient(135deg, #411d6e 0%, #4d2281 50%, #55258e 100%) !important;">
<button class="parent-panel-tab-button flex-auto text-sm font-medium py-2 px-3 rounded-md" data-tab="parent-genel-ozet">Genel Özet</button>
<button class="parent-panel-tab-button flex-auto text-sm font-medium py-2 px-3 rounded-md" data-tab="parent-gunluk-rapor">Günlük Rapor</button>
<button class="parent-panel-tab-button flex-auto text-sm font-medium py-2 px-3 rounded-md" data-tab="parent-haftalik-rapor">Haftalık Rapor</button>
<button class="parent-panel-tab-button flex-auto text-sm font-medium py-2 px-3 rounded-md" data-tab="parent-aylik-rapor">Aylık Rapor</button>
</div>
<div>
<div class="panel-tab-content space-y-8" id="parent-genel-ozet">
<div class="">
<button class="w-full sm:w-auto bg-gradient-to-r from-purple-500 to-indigo-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition duration-300 ease-in-out flex items-center justify-center space-x-2" id="getGeminiSummary">
<ion-icon class="text-2xl" name="sparkles-outline"></ion-icon>
<span>✨ Yapay Zeka Gelişim Özeti Al</span>
</button>
</div>
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
<div class="bg-transparent bg-opacity-20 backdrop-blur-lg rounded-2xl shadow-xl p-6 border border-white border-opacity-20 flex items-center space-x-4" style="background: linear-gradient(135deg, #411d6e 0%, #4d2281 50%, #55258e 100%) !important;">
<div class="bg-purple-600 bg-opacity-30 p-3 rounded-full"><ion-icon class="text-4xl text-purple-300" name="checkmark-done-circle-outline"></ion-icon></div>
<div>
<div class="text-sm font-medium text-gray-300 uppercase">Toplam Çözülen Soru</div>
<p class="text-3xl font-bold text-white" id="parent-stat-total">0</p>
</div>
</div>
<div class="bg-transparent bg-opacity-20 backdrop-blur-lg rounded-2xl shadow-xl p-6 border border-white border-opacity-20 flex items-center space-x-4" style="background: linear-gradient(135deg, #411d6e 0%, #4d2281 50%, #55258e 100%) !important;">
<div class="bg-yellow-600 bg-opacity-30 p-3 rounded-full"><ion-icon class="text-4xl text-yellow-300" name="time-outline"></ion-icon></div>
<div>
<div class="text-sm font-medium text-gray-300 uppercase">Onay Bekleyen</div>
<p class="text-3xl font-bold text-white" id="parent-stat-pending">0</p>
</div>
</div>
<div class="bg-transparent bg-opacity-20 backdrop-blur-lg rounded-2xl shadow-xl p-6 border border-white border-opacity-20 flex items-center space-x-4" style="background: linear-gradient(135deg, #411d6e 0%, #4d2281 50%, #55258e 100%) !important;">
<div class="bg-green-600 bg-opacity-30 p-3 rounded-full"><ion-icon class="text-4xl text-green-300" name="trending-up-outline"></ion-icon></div>
<div>
<div class="text-sm font-medium text-gray-300 uppercase">Bu Hafta</div>
<p class="text-3xl font-bold text-white" id="parent-stat-weekly">0 Soru</p>
</div>
</div>
<div class="bg-transparent bg-opacity-20 backdrop-blur-lg rounded-2xl shadow-xl p-6 border border-white border-opacity-20 flex items-center space-x-4" style="background: linear-gradient(135deg, #411d6e 0%, #4d2281 50%, #55258e 100%) !important;">
<div class="bg-blue-600 bg-opacity-30 p-3 rounded-full"><ion-icon class="text-4xl text-blue-300" name="ribbon-outline"></ion-icon></div>
<div>
<div class="text-sm font-medium text-gray-300 uppercase">Genel Başarı</div>
<p class="text-3xl font-bold text-white" id="parent-stat-success">-%</p>
</div>
</div>
</div>
<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
<div class="lg:col-span-2">
<div class="bg-transparent bg-opacity-20 backdrop-blur-lg rounded-2xl shadow-xl border border-white border-opacity-20 overflow-hidden" style="background: linear-gradient(135deg, #411d6e 0%, #4d2281 50%, #55258e 100%) !important;">
<h3 class="text-xl font-semibold text-white p-6 border-b border-white border-opacity-10">Derslere Göre Dağılım</h3>
<div class="overflow-x-auto">
<table class="w-full min-w-full">
<thead class="bg-white bg-opacity-10">
<tr>
<th class="py-3 px-6 text-left text-sm font-medium text-gray-300 uppercase tracking-wider">Ders Adı</th>
<th class="py-3 px-6 text-left text-sm font-medium text-gray-300 uppercase tracking-wider">Toplam Soru</th>
<th class="py-3 px-6 text-left text-sm font-medium text-gray-300 uppercase tracking-wider">Doğru</th>
<th class="py-3 px-6 text-left text-sm font-medium text-gray-300 uppercase tracking-wider">Yanlış</th>
<th class="py-3 px-6 text-left text-sm font-medium text-gray-300 uppercase tracking-wider">Başarı</th>
<th class="py-3 px-6 text-left text-sm font-medium text-gray-300 uppercase tracking-wider">Durum</th>
</tr>
</thead>
<tbody class="divide-y divide-white divide-opacity-10" id="parent-ders-tablosu-body">
<tr><td class="py-4 px-6 text-center text-gray-400" colspan="6">Veri yükleniyor...</td></tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="lg:col-span-1">
<div class="bg-transparent bg-opacity-20 backdrop-blur-lg rounded-2xl shadow-xl border border-white border-opacity-20 p-6" style="background: linear-gradient(135deg, #411d6e 0%, #4d2281 50%, #55258e 100%) !important;">
<h3 class="text-xl font-semibold text-white mb-4">Öğretmen Notları</h3>
<ul class="space-y-4" id="parent-ogretmen-notlari">
<li class="p-4 bg-white bg-opacity-10 rounded-lg">
<p class="not-icerigi text-sm text-gray-200">Notlar henüz eklenmedi.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="panel-tab-content" id="parent-gunluk-rapor">
<div class="bg-transparent bg-opacity-20 backdrop-blur-lg rounded-2xl shadow-2xl p-6 border border-white border-opacity-20" style="background: linear-gradient(135deg, #411d6e 0%, #4d2281 50%, #55258e 100%) !important;">
<h2 class="text-2xl font-bold mb-5 text-purple-300">Günlük Rapor</h2>
<div class="flex justify-between items-center mb-4">
<button class="p-2 rounded-full hover:bg-white hover:bg-opacity-10 transition focus:outline-none focus:ring-2 focus:ring-purple-500" id="parent-prev-month">
<svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M15 19l-7-7 7-7" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg>
</button>
<h3 class="text-xl font-semibold" id="parent-month-year"></h3>
<button class="p-2 rounded-full hover:bg-white hover:bg-opacity-10 transition focus:outline-none focus:ring-2 focus:ring-purple-500" id="parent-next-month">
<svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M9 5l7 7-7 7" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg>
</button>
</div>
<div class="grid grid-cols-7 gap-1 text-center mb-2">
<span class="text-xs font-bold text-purple-300 uppercase">PZT</span>
<span class="text-xs font-bold text-purple-300 uppercase">SAL</span>
<span class="text-xs font-bold text-purple-300 uppercase">ÇAR</span>
<span class="text-xs font-bold text-purple-300 uppercase">PER</span>
<span class="text-xs font-bold text-purple-300 uppercase">CUM</span>
<span class="text-xs font-bold text-purple-300 uppercase">CMT</span>
<span class="text-xs font-bold text-purple-300 uppercase">PAZ</span>
</div>
<div class="grid grid-cols-7 gap-1" id="parent-calendar-grid">
</div>
<div class="mt-8 hidden" id="parent-daily-details">
<h3 class="text-lg font-semibold text-purple-300 mb-4" id="parent-details-title">Seçilen Günün Detayları</h3>
<div class="overflow-x-auto table-container">
<table class="w-full min-w-[400px] text-left">
<thead class="border-b border-white border-opacity-30">
<tr>
<th class="py-2 px-3 text-sm font-semibold uppercase text-gray-300">Ders</th>
<th class="py-2 px-3 text-sm font-semibold uppercase text-gray-300 text-center">D</th>
<th class="py-2 px-3 text-sm font-semibold uppercase text-gray-300 text-center">Y</th>
<th class="py-2 px-3 text-sm font-semibold uppercase text-gray-300 text-center">Toplam</th>
</tr>
</thead>
<tbody class="divide-y divide-white divide-opacity-10" id="parent-details-table-body">
<tr><td class="py-3 px-3 text-center text-gray-400" colspan="4">Veri bulunamadı.</td></tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
<div class="panel-tab-content" id="parent-haftalik-rapor">
<div class="space-y-6">
<div class="bg-transparent bg-opacity-20 backdrop-blur-lg rounded-2xl shadow-2xl p-6 border border-white border-opacity-20 flex flex-col sm:flex-row justify-between sm:items-center gap-4" style="background: linear-gradient(135deg, #411d6e 0%, #4d2281 50%, #55258e 100%) !important;">
<h2 class="text-2xl font-bold text-purple-300">Haftalık Rapor</h2>
<div class="flex items-center space-x-2 shrink-0">
<label class="text-sm font-medium text-gray-300" for="parent-week-select">Hafta:</label>
<select class="p-2 rounded-lg dark-input text-sm" id="parent-week-select"></select>
</div>
</div>
<div class="bg-transparent bg-opacity-20 backdrop-blur-lg rounded-2xl shadow-2xl p-6 border border-white border-opacity-20" style="background: linear-gradient(135deg, #411d6e 0%, #4d2281 50%, #55258e 100%) !important;">
<h3 class="text-lg font-semibold mb-4 text-purple-300">Haftalık Toplam Soru (Günlük)</h3>
<div class="h-64 md:h-80">
<canvas id="parent-weekly-chart-canvas"></canvas>
</div>
</div>
<div class="bg-transparent bg-opacity-20 backdrop-blur-lg rounded-2xl shadow-2xl p-6 border border-white border-opacity-20" style="background: linear-gradient(135deg, #411d6e 0%, #4d2281 50%, #55258e 100%) !important;">
<h3 class="text-lg font-semibold mb-4 text-purple-300">Derslere Göre Haftalık Döküm (Toplam Soru)</h3>
<div class="overflow-x-auto table-container">
<table class="w-full text-left">
<thead class="border-b border-white border-opacity-30">
<tr>
<th class="py-2 px-3 text-xs font-semibold uppercase text-gray-300 sticky left-0 z-10" style="background-color: rgba(0,0,0,0.2); backdrop-filter: blur(10px);">Ders</th>
<th class="py-2 px-3 text-xs font-semibold uppercase text-gray-300 text-center">Pzt</th>
<th class="py-2 px-3 text-xs font-semibold uppercase text-gray-300 text-center">Sal</th>
<th class="py-2 px-3 text-xs font-semibold uppercase text-gray-300 text-center">Çar</th>
<th class="py-2 px-3 text-xs font-semibold uppercase text-gray-300 text-center">Per</th>
<th class="py-2 px-3 text-xs font-semibold uppercase text-gray-300 text-center">Cum</th>
<th class="py-2 px-3 text-xs font-semibold uppercase text-gray-300 text-center">Cmt</th>
<th class="py-2 px-3 text-xs font-semibold uppercase text-gray-300 text-center">Paz</th>
<th class="py-2 px-3 text-xs font-semibold uppercase text-gray-300 text-center">Top</th>
</tr>
</thead>
<tbody class="divide-y divide-white divide-opacity-10" id="parent-weekly-details-body">
</tbody>
</table>
</div>
</div>
</div>
</div>
<div class="panel-tab-content" id="parent-aylik-rapor">
<div class="space-y-6">
<div class="bg-transparent bg-opacity-20 backdrop-blur-lg rounded-2xl shadow-2xl p-6 border border-white border-opacity-20 flex flex-col sm:flex-row justify-between sm:items-center gap-4" style="background: linear-gradient(135deg, #411d6e 0%, #4d2281 50%, #55258e 100%) !important;">
<h2 class="text-2xl font-bold text-purple-300">Aylık Rapor</h2>
<div class="flex items-center space-x-2 shrink-0">
<label class="text-sm font-medium text-gray-300" for="parent-month-select">Ay:</label>
<input class="p-2 rounded-lg dark-input text-sm" id="parent-month-select" type="month"/>
</div>
</div>
<div class="bg-transparent bg-opacity-20 backdrop-blur-lg rounded-2xl shadow-2xl p-6 border border-white border-opacity-20" style="background: linear-gradient(135deg, #411d6e 0%, #4d2281 50%, #55258e 100%) !important;">
<h3 class="text-lg font-semibold mb-4 text-purple-300">Derslere Göre Toplam Soru Sayısı</h3>
<div class="h-64 md:h-80">
<canvas id="parent-monthly-chart-canvas"></canvas>
</div>
</div>
<div class="bg-transparent bg-opacity-20 backdrop-blur-lg rounded-2xl shadow-2xl p-6 border border-white border-opacity-20" style="background: linear-gradient(135deg, #411d6e 0%, #4d2281 50%, #55258e 100%) !important;">
<h3 class="text-lg font-semibold mb-4 text-purple-300">Aylık Ders Dökümü</h3>
<div class="overflow-x-auto table-container">
<table class="w-full min-w-[500px] text-left">
<thead class="border-b border-white border-opacity-30">
<tr>
<th class="py-2 px-3 text-sm font-semibold uppercase text-gray-300">Ders</th>
<th class="py-2 px-3 text-sm font-semibold uppercase text-gray-300 text-center">Toplam Soru</th>
<th class="py-2 px-3 text-sm font-semibold uppercase text-gray-300 text-center">Doğru</th>
<th class="py-2 px-3 text-sm font-semibold uppercase text-gray-300 text-center">Yanlış</th>
<th class="py-2 px-3 text-sm font-semibold uppercase text-gray-300 text-center">Başarı</th>
</tr>
</thead>
<tbody class="divide-y divide-white divide-opacity-10" id="parent-monthly-details-body">
<tr><td class="py-3 px-3 text-center text-gray-400" colspan="5">Veri yükleniyor...</td></tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>
</main>
</div>
<div class="modal-backdrop" id="loadingModal">
<div class="modal-content flex flex-col items-center justify-center text-center">
<div class="w-12 h-12 border-4 border-purple-400 border-t-transparent rounded-full animate-spin-fast mb-4"></div>
<h3 class="text-xl font-semibold text-purple-300">Analiz Hazırlanıyor...</h3>
<p class="text-gray-300">Öğrencinizin verileri yapay zeka tarafından inceleniyor. Lütfen bekleyin.</p>
</div>
</div>
<div class="modal-backdrop" id="geminiResultModal">
<div class="modal-content">
<div class="flex justify-between items-center mb-4">
<h2 class="text-2xl font-bold text-white flex items-center space-x-2">
<ion-icon class="text-purple-400" name="sparkles"></ion-icon>
<span>Yapay Zeka Gelişim Özeti</span>
</h2>
<button class="text-gray-400 hover:text-white text-3xl" id="closeGeminiModal">×</button>
</div>
<div class="text-gray-200 max-h-[60vh] overflow-y-auto pr-2" id="geminiResultContent">
</div>
<button class="mt-6 w-full bg-purple-600 text-white py-2 px-4 rounded-lg hover:bg-purple-700 font-medium transition duration-150" id="closeGeminiModalBtn">
                Kapat
            </button>
</div>
</div>
<div class="" id="teacher-panel">
<nav class="bg-transparent bg-opacity-20 backdrop-blur-lg shadow-lg border-b border-white border-opacity-10 sticky top-0 z-50" style="background: linear-gradient(135deg, #411d6e 0%, #4d2281 50%, #55258e 100%) !important;">
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
<div class="flex items-center justify-between h-16">
<div class="flex items-center space-x-3">
<div class="bg-white bg-opacity-10 p-2 rounded-full">
<svg class="w-6 h-6 text-purple-400" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
<path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
</svg>
</div>
<span class="text-xl font-bold text-white">ÖĞRETMEN PANELİ</span>
</div>
<div class="flex items-center space-x-4">
<div class="text-right text-sm">
<div class="font-medium text-white hidden" id="teacher-welcome-name">Öğretmen: ...</div>
<div class="text-gray-300" id="teacher-welcome-role">Yönetici</div>
</div>
<button class="bg-red-600 hover:bg-red-700 text-white text-sm font-medium py-2 px-3 rounded-lg transition duration-150 flex items-center space-x-1" id="teacher-logout-button">
<ion-icon class="text-lg" name="log-out-outline"></ion-icon>
<span>Çıkış Yap</span>
</button>
</div>
</div>
</div>
</nav>
<main class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
<div class="mb-6">
<h1 class="text-3xl font-bold text-white shadow-sm">Sınıf Yönetimi</h1>
<p class="text-lg text-gray-300" id="teacher-welcome-name-below">Öğretmen: ...</p>
</div>
<div class="flex flex-wrap gap-2 bg-transparent bg-opacity-20 border border-white border-opacity-20 rounded-lg p-1 mb-6 max-w-xl" style="background: linear-gradient(135deg, #411d6e 0%, #4d2281 50%, #55258e 100%) !important;">
<button class="teacher-panel-tab-button panel-tab-button flex-auto text-sm font-medium py-2 px-3 rounded-md" data-tab="teacher-genel-ozet">Genel Özet</button>
<button class="teacher-panel-tab-button panel-tab-button flex-auto text-sm font-medium py-2 px-3 rounded-md" data-tab="teacher-siniflar">Sınıflar</button>
<button class="teacher-panel-tab-button panel-tab-button flex-auto text-sm font-medium py-2 px-3 rounded-md" data-tab="teacher-favoriler">Favoriler</button>
</div>
<div>
<div class="panel-tab-content" id="teacher-genel-ozet">
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
<div class="bg-transparent bg-opacity-20 backdrop-blur-lg rounded-2xl shadow-xl p-5 border border-white border-opacity-20 flex items-center space-x-4" style="background: linear-gradient(135deg, #411d6e 0%, #4d2281 50%, #55258e 100%) !important;">
<div class="bg-blue-600 bg-opacity-30 p-3 rounded-full">
<ion-icon class="text-3xl text-blue-300" name="people-outline"></ion-icon>
</div>
<div>
<div class="text-sm font-medium text-gray-300 uppercase">Kayıtlı Öğrenci</div>
<div class="text-2xl font-bold text-white" id="teacher-stat-registered">-</div>
</div>
</div>
<div class="bg-transparent bg-opacity-20 backdrop-blur-lg rounded-2xl shadow-xl p-5 border border-white border-opacity-20 flex items-center space-x-4" style="background: linear-gradient(135deg, #411d6e 0%, #4d2281 50%, #55258e 100%) !important;">
<div class="bg-yellow-600 bg-opacity-30 p-3 rounded-full">
<ion-icon class="text-3xl text-yellow-300" name="trophy-outline"></ion-icon>
</div>
<div class="min-w-0 flex-1"><div class="text-sm font-medium text-gray-300 uppercase">Günün Birincisi</div>
<div class="text-lg font-bold text-white truncate" title=""><span <span class="text-lg font-bold text-white truncate block text-lg font-bold text-white truncate" id="teacher-stat-daily"></span></div>
</div>
</div>
<div class="bg-transparent bg-opacity-20 backdrop-blur-lg rounded-2xl shadow-xl p-5 border border-white border-opacity-20 flex items-center space-x-4" style="background: linear-gradient(135deg, #411d6e 0%, #4d2281 50%, #55258e 100%) !important;">
<div class="bg-green-600 bg-opacity-30 p-3 rounded-full">
<ion-icon class="text-3xl text-green-300" name="ribbon-outline"></ion-icon>
</div>
<div class="min-w-0 flex-1"><div class="text-sm font-medium text-gray-300 uppercase">Haftanın Birincisi</div>
<div class="text-lg font-bold text-white truncate" title=""><span <span class="text-lg font-bold text-white truncate block text-lg font-bold text-white truncate" id="teacher-stat-weekly"></span></div>
</div>
</div>
<div class="bg-transparent bg-opacity-20 backdrop-blur-lg rounded-2xl shadow-xl p-5 border border-white border-opacity-20 flex items-center space-x-4" style="background: linear-gradient(135deg, #411d6e 0%, #4d2281 50%, #55258e 100%) !important;">
<div class="bg-purple-600 bg-opacity-30 p-3 rounded-full">
<ion-icon class="text-3xl text-purple-300" name="school-outline"></ion-icon>
</div>
<div class="min-w-0 flex-1"><div class="text-sm font-medium text-gray-300 uppercase">Ayın Birincisi</div>
<div class="text-lg font-bold text-white truncate" title=""><span <span class="text-lg font-bold text-white truncate block text-lg font-bold text-white truncate" id="teacher-stat-monthly"></span></div>
</div>
</div>
</div>
<div class="grid grid-cols-1 gap-6">
<div class="bg-transparent bg-opacity-20 backdrop-blur-lg rounded-2xl shadow-2xl p-6 border border-white border-opacity-20" style="background: linear-gradient(135deg, #411d6e 0%, #4d2281 50%, #55258e 100%) !important;">
<h3 class="text-lg font-semibold mb-4 text-purple-300">Sınıflara Göre Toplam Soru (Bu Ay)</h3>
<div class="h-80">
<canvas id="class-bar-chart"></canvas>
</div>
</div>
</div>
</div>
<div class="panel-tab-content" id="teacher-siniflar">
<div class="bg-transparent bg-opacity-20 backdrop-blur-lg rounded-2xl shadow-2xl p-6 border border-white border-opacity-20" style="background: linear-gradient(135deg, #411d6e 0%, #4d2281 50%, #55258e 100%) !important;">
<h2 class="text-2xl font-bold mb-5 text-purple-300">Sınıfları Yönet</h2>
<div class="flex flex-col sm:flex-row gap-3 sm:gap-4 mb-6">
  <input
    id="sinif-ekle-input"
    type="text"
    placeholder="Yeni sınıf adı (örn: 6-C)"
    class="dark-input flex-grow p-2.5 rounded-lg min-w-0"
  />
  <button
    id="sinif-ekle-buton"
    class="bg-purple-600 hover:bg-purple-700 text-white font-medium py-2.5 px-6 rounded-lg transition-all flex items-center justify-center space-x-2 w-full sm:w-auto"
  >
    <ion-icon class="text-xl" name="add-circle-outline"></ion-icon>
    <span>Ekle</span>
  </button>
</div>
<div class="text-red-400 text-sm mb-4 hidden" id="sinif-hata-mesaji"></div>
<div class="">
<h3 class="text-lg font-semibold text-gray-300 mb-2">Mevcut Sınıflar</h3>
<div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="sinif-listesi-container">
</div>
</div>
</div>
</div>
<div class="panel-tab-content" id="teacher-favoriler">
<div class="bg-transparent bg-opacity-20 backdrop-blur-lg rounded-2xl shadow-2xl p-6 border border-white border-opacity-20" style="background: linear-gradient(135deg, #411d6e 0%, #4d2281 50%, #55258e 100%) !important;">
<h2 class="text-2xl font-bold mb-5 text-purple-300">Favori Öğrenciler</h2>
<div class="space-y-1" id="favorites-list-container">
<p class="text-gray-400 italic">Favori öğrenci bulunamadı. Sınıf listesinden bir öğrencinin yanındaki yıldıza tıklayarak ekleyebilirsiniz.</p>
</div>
</div>
</div>
</div>
</main>
<div class="modal-backdrop" id="studentListModal">
<div class="modal-content bg-transparent bg-opacity-20 backdrop-blur-lg border border-white border-opacity-20" style="background: linear-gradient(135deg, #411d6e 0%, #4d2281 50%, #55258e 100%) !important;">
<div class="flex justify-between items-center mb-4">
<h2 class="text-2xl font-bold text-purple-300" id="studentListModalTitle">Öğrenci Listesi</h2>
<button class="text-gray-400 hover:text-white text-3xl" id="closeStudentListModal">×</button>
</div>
<div class="text-gray-200 max-h-[60vh] overflow-y-auto pr-2" id="studentListModalContent">
</div>
</div>
</div>
<div class="modal-backdrop" id="studentDetailModal">
<div class="modal-content"> <div class="flex justify-between items-center mb-4">
<h2 class="text-3xl font-bold text-purple-300" id="studentDetailModalTitle">Öğrenci Raporu</h2>
<button class="text-gray-400 hover:text-white text-4xl" id="closeStudentDetailModal">×</button>
</div>
<div class="text-center p-8" id="studentDetailModalLoading">
<div class="w-12 h-12 border-4 border-purple-400 border-t-transparent rounded-full animate-spin-fast mx-auto mb-4"></div>
<p class="text-lg text-gray-300">Öğrenci verileri yükleniyor...</p>
</div>
<div class="hidden" id="studentDetailModalContent">
<div class="flex flex-wrap gap-2 bg-transparent bg-opacity-20 border border-white border-opacity-20 rounded-lg p-1 mb-6 max-w-xl" style="background: linear-gradient(135deg, #411d6e 0%, #4d2281 50%, #55258e 100%) !important;">
<button class="student-detail-tab-button flex-auto text-sm font-medium py-2 px-3 rounded-md" data-tab="tsr-gunluk-rapor">Günlük Rapor</button>
<button class="student-detail-tab-button flex-auto text-sm font-medium py-2 px-3 rounded-md" data-tab="tsr-haftalik-rapor">Haftalık Rapor</button>
<button class="student-detail-tab-button flex-auto text-sm font-medium py-2 px-3 rounded-md" data-tab="tsr-aylik-rapor">Aylık Rapor</button>

<button id="tsr-envelope-btn" role="button" class="flex-none text-lg font-medium py-2 px-3 rounded-md hover:bg-white hover:bg-opacity-10 focus:outline-none focus:ring-2 focus:ring-purple-500" title="Mesaj">✉️</button>
</div>
<div>
<div class="student-detail-tab-content" id="tsr-gunluk-rapor">
<div class="bg-transparent bg-opacity-20 backdrop-blur-lg rounded-2xl shadow-2xl p-6 border border-white border-opacity-20" style="background: linear-gradient(135deg, #411d6e 0%, #4d2281 50%, #55258e 100%) !important;">
<h2 class="text-2xl font-bold mb-5 text-purple-300">Günlük Rapor</h2>
<div class="flex justify-between items-center mb-4">
<button class="p-2 rounded-full hover:bg-white hover:bg-opacity-10 transition focus:outline-none focus:ring-2 focus:ring-purple-500" id="tsr-prev-month">
<svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M15 19l-7-7 7-7" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg>
</button>
<h3 class="text-xl font-semibold" id="tsr-month-year"></h3>
<button class="p-2 rounded-full hover:bg-white hover:bg-opacity-10 transition focus:outline-none focus:ring-2 focus:ring-purple-500" id="tsr-next-month">
<svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M9 5l7 7-7 7" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg>
</button>
</div>
<div class="grid grid-cols-7 gap-1 text-center mb-2">
<span class="text-xs font-bold text-purple-300 uppercase">PZT</span>
<span class="text-xs font-bold text-purple-300 uppercase">SAL</span>
<span class="text-xs font-bold text-purple-300 uppercase">ÇAR</span>
<span class="text-xs font-bold text-purple-300 uppercase">PER</span>
<span class="text-xs font-bold text-purple-300 uppercase">CUM</span>
<span class="text-xs font-bold text-purple-300 uppercase">CMT</span>
<span class="text-xs font-bold text-purple-300 uppercase">PAZ</span>
</div>
<div class="grid grid-cols-7 gap-1" id="tsr-calendar-grid">
</div>
<div class="mt-8 hidden" id="tsr-daily-details">
<h3 class="text-lg font-semibold text-purple-300 mb-4" id="tsr-details-title">Seçilen Günün Detayları</h3>
<div class="overflow-x-auto table-container">
<table class="w-full min-w-[400px] text-left">
<thead class="border-b border-white border-opacity-30">
<tr>
<th class="py-2 px-3 text-sm font-semibold uppercase text-gray-300">Ders</th>
<th class="py-2 px-3 text-sm font-semibold uppercase text-gray-300 text-center">D</th>
<th class="py-2 px-3 text-sm font-semibold uppercase text-gray-300 text-center">Y</th>
<th class="py-2 px-3 text-sm font-semibold uppercase text-gray-300 text-center">Toplam</th>
</tr>
</thead>
<tbody class="divide-y divide-white divide-opacity-10" id="tsr-details-table-body">
<tr><td class="py-3 px-3 text-center text-gray-400" colspan="4">Veri bulunamadı.</td></tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
<div class="student-detail-tab-content" id="tsr-haftalik-rapor">
<div class="space-y-6">
<div class="bg-transparent bg-opacity-20 backdrop-blur-lg rounded-2xl shadow-2xl p-6 border border-white border-opacity-20 flex flex-col sm:flex-row justify-between sm:items-center gap-4" style="background: linear-gradient(135deg, #411d6e 0%, #4d2281 50%, #55258e 100%) !important;">
<h2 class="text-2xl font-bold text-purple-300">Haftalık Rapor</h2>
<div class="flex items-center space-x-2 shrink-0">
<label class="text-sm font-medium text-gray-300" for="tsr-week-select">Hafta:</label>
<select class="p-2 rounded-lg dark-input text-sm" id="tsr-week-select"></select>
</div>
</div>
<div class="bg-transparent bg-opacity-20 backdrop-blur-lg rounded-2xl shadow-2xl p-6 border border-white border-opacity-20" style="background: linear-gradient(135deg, #411d6e 0%, #4d2281 50%, #55258e 100%) !important;">
<h3 class="text-lg font-semibold mb-4 text-purple-300">Haftalık Toplam Soru (Günlük)</h3>
<div class="h-64 md:h-80">
<canvas id="tsr-weekly-chart-canvas"></canvas>
</div>
</div>
<div class="bg-transparent bg-opacity-20 backdrop-blur-lg rounded-2xl shadow-2xl p-6 border border-white border-opacity-20" style="background: linear-gradient(135deg, #411d6e 0%, #4d2281 50%, #55258e 100%) !important;">
<h3 class="text-lg font-semibold mb-4 text-purple-300">Derslere Göre Haftalık Döküm (Toplam Soru)</h3>
<div class="overflow-x-auto table-container">
<table class="w-full text-left">
<thead class="border-b border-white border-opacity-30">
<tr>
<th class="py-2 px-3 text-xs font-semibold uppercase text-gray-300 sticky left-0 z-10" style="background-color: rgba(0,0,0,0.2); backdrop-filter: blur(10px);">Ders</th>
<th class="py-2 px-3 text-xs font-semibold uppercase text-gray-300 text-center">Pzt</th>
<th class="py-2 px-3 text-xs font-semibold uppercase text-gray-300 text-center">Sal</th>
<th class="py-2 px-3 text-xs font-semibold uppercase text-gray-300 text-center">Çar</th>
<th class="py-2 px-3 text-xs font-semibold uppercase text-gray-300 text-center">Per</th>
<th class="py-2 px-3 text-xs font-semibold uppercase text-gray-300 text-center">Cum</th>
<th class="py-2 px-3 text-xs font-semibold uppercase text-gray-300 text-center">Cmt</th>
<th class="py-2 px-3 text-xs font-semibold uppercase text-gray-300 text-center">Paz</th>
<th class="py-2 px-3 text-xs font-semibold uppercase text-gray-300 text-center">Top</th>
</tr>
</thead>
<tbody class="divide-y divide-white divide-opacity-10" id="tsr-weekly-details-body">
</tbody>
</table>
</div>
</div>
</div>
</div>
<div class="student-detail-tab-content" id="tsr-aylik-rapor">
<div class="space-y-6">
<div class="bg-transparent bg-opacity-20 backdrop-blur-lg rounded-2xl shadow-2xl p-6 border border-white border-opacity-20 flex flex-col sm:flex-row justify-between sm:items-center gap-4" style="background: linear-gradient(135deg, #411d6e 0%, #4d2281 50%, #55258e 100%) !important;">
<h2 class="text-2xl font-bold text-purple-300">Aylık Rapor</h2>
<div class="flex items-center space-x-2 shrink-0">
<label class="text-sm font-medium text-gray-300" for="tsr-month-select">Ay:</label>
<input class="p-2 rounded-lg dark-input text-sm" id="tsr-month-select" type="month"/>
</div>
</div>
<div class="bg-transparent bg-opacity-20 backdrop-blur-lg rounded-2xl shadow-2xl p-6 border border-white border-opacity-20" style="background: linear-gradient(135deg, #411d6e 0%, #4d2281 50%, #55258e 100%) !important;">
<h3 class="text-lg font-semibold mb-4 text-purple-300">Derslere Göre Toplam Soru Sayısı</h3>
<div class="h-64 md:h-80">
<canvas id="tsr-monthly-chart-canvas"></canvas>
</div>
</div>
<div class="bg-transparent bg-opacity-20 backdrop-blur-lg rounded-2xl shadow-2xl p-6 border border-white border-opacity-20" style="background: linear-gradient(135deg, #411d6e 0%, #4d2281 50%, #55258e 100%) !important;">
<h3 class="text-lg font-semibold mb-4 text-purple-300">Aylık Ders Dökümü</h3>
<div class="overflow-x-auto table-container">
<table class="w-full min-w-[500px] text-left">
<thead class="border-b border-white border-opacity-30">
<tr>
<th class="py-2 px-3 text-sm font-semibold uppercase text-gray-300">Ders</th>
<th class="py-2 px-3 text-sm font-semibold uppercase text-gray-300 text-center">Toplam Soru</th>
<th class="py-2 px-3 text-sm font-semibold uppercase text-gray-300 text-center">Doğru</th>
<th class="py-2 px-3 text-sm font-semibold uppercase text-gray-300 text-center">Yanlış</th>
<th class="py-2 px-3 text-sm font-semibold uppercase text-gray-300 text-center">Başarı</th>
</tr>
</thead>
<tbody class="divide-y divide-white divide-opacity-10" id="tsr-monthly-details-body">
<tr><td class="py-3 px-3 text-center text-gray-400" colspan="5">Veri yükleniyor...</td></tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<script>
        // ---------------------------------------------
        // ** KÜRESEL AYARLAR VE DEĞİŞKENLER **
        // ---------------------------------------------
        
        // Firebase Yapılandırması 
        const firebaseConfig = {
            // ÖNEMLİ: Kendi Firebase Proje Ayarlarınızdan aldığınız 
            // gerçek değerleri buraya yapıştırın.
            apiKey: "YOUR_API_KEY", 
            authDomain: "kocluksistemi-c00bd.firebaseapp.com",
            databaseURL: "https://kocluksistemi-c00bd-default-rtdb.europe-west1.firebasedatabase.app/",
            projectId: "kocluksistemi-c00bd",
            storageBucket: "kocluksistemi-c00bd.appspot.com",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID" 
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        let currentUserId = null; // Giriş yapan kullanıcının (öğrenci/veli) ID'si
        let currentUserName = null; // Giriş yapan kullanıcının Adı Soyadı
        let currentUserRole = null; // 'ogrenci', 'veli' veya 'ogretmen'
        
        // *** KİLİT DEĞİŞKEN: HANGİ ÖĞRENCİNİN VERİSİ GÖSTERİLECEK ***
        let currentStudentId = null; // Veli ise çocuğunun ID'si, öğrenci ise kendi ID'si
        
        // Ders adları ve kısaltmalar (Panel için)
        const allSubjectsMap = {
            'Matematik': 'Mat', 'Türkçe': 'Trk', 'Fen Bilimleri': 'Fen',
            'Sosyal Bilgiler': 'Sos', 'İngilizce': 'İng', 'Din Kültürü': 'Din'
        };
        const allSubjectsFull = Object.keys(allSubjectsMap);
        const daysOfWeekShort = ['Pzt', 'Sal', 'Çar', 'Per', 'Cum', 'Cmt', 'Paz'];
        const monthNames = ["Ocak", "Şubat", "Mart", "Nisan", "Mayıs", "Haziran", "Temmuz", "Ağustos", "Eylül", "Ekim", "Kasım", "Aralık"];

        // --- İSTEK 3: Beni Hatırla Helper Fonksiyonları ---
        function saveLogin(prefix, id, pass) {
            localStorage.setItem(`remember_${prefix}_id`, id);
            localStorage.setItem(`remember_${prefix}_pass`, pass);
            localStorage.setItem(`remember_${prefix}_check`, 'true');
        }
        
        function clearLogin(prefix) {
            localStorage.removeItem(`remember_${prefix}_id`);
            localStorage.removeItem(`remember_${prefix}_pass`);
            localStorage.removeItem(`remember_${prefix}_check`);
        }
        // --- /İSTEK 3 ---

        // --- Yardımcı Fonksiyonlar ---

        function showNotification(message, type = 'success', duration = 3000) {
            const box = document.createElement('div');
            let colorClass = (type === 'success') ? 'bg-green-600' : (type === 'error') ? 'bg-red-600' : 'bg-blue-600';
            
            box.className = `${colorClass} text-white p-3 mb-2 rounded-lg shadow-xl transition-opacity duration-300 ease-out opacity-0 translate-y-2`;
            box.textContent = message;
            box.style.pointerEvents = 'auto'; 
            
            const notificationBox = document.getElementById('notification-box');
            if(notificationBox) {
                notificationBox.appendChild(box);

                setTimeout(() => {
                    box.classList.remove('opacity-0', 'translate-y-2');
                    box.classList.add('opacity-100', 'translate-y-0');
                }, 10);
                
                setTimeout(() => {
                    box.classList.remove('opacity-100', 'translate-y-0');
                    box.classList.add('opacity-0', 'translate-y-2');
                    setTimeout(() => box.remove(), 300);
                }, duration);
            }
        }

        // Ekran Değiştirme Fonksiyonu (GÜNCELLENDİ)
        function showScreen(screenId, userData = null) {
            document.getElementById('auth-page').classList.add('hidden');
            document.getElementById('student-panel').classList.add('hidden');
            document.getElementById('parent-panel').classList.add('hidden');
            document.getElementById('teacher-panel').classList.add('hidden'); // YENİ

            currentUserId = null;
            currentUserRole = null;
            currentStudentId = null; // Her ekran değişiminde sıfırla

            if (screenId === 'student-panel') {
                if (userData) {
                    currentUserId = userData.ogrenciNo;
                    currentUserName = `${userData.ad} ${userData.soyad}`;
                    currentUserRole = 'ogrenci';
                    currentStudentId = userData.ogrenciNo; // Öğrenci kendi ID'sini kullanır

                    document.getElementById('welcome-user-name').textContent = currentUserName;
                    
                    document.getElementById('student-panel').classList.remove('hidden');
                    loadInitialData(); // Öğrencinin verilerini yükle
                } else {
                    showScreen('auth-page');
                }
            } else if (screenId === 'parent-panel') {
                 if (userData) {
                    currentUserId = userData.veliId; // veli-ogrenciNo
                    currentUserName = `${userData.ad} ${userData.soyad}`;
                    currentUserRole = 'veli';
                    currentStudentId = userData.cocukOgrenciNo; // Veli, çocuğunun ID'sini kullanır
                    
                    const studentInfo = `${userData.cocukAd} ${userData.cocukSoyad} (${userData.cocukSinif})`;

                    document.getElementById('parent-welcome-veli-name').textContent = `Veli: ${currentUserName}`;
                    document.getElementById('parent-welcome-student-info').textContent = `Öğrenci: ${studentInfo}`;
                    document.getElementById('parent-student-summary-title').textContent = `${studentInfo} için genel durum.`;

                    document.getElementById('parent-panel').classList.remove('hidden');
                    loadInitialData(); // Veli girişi, çocuğunun verilerini yükler
                } else {
                    showScreen('auth-page');
                }
            }
            // YENİ: Öğretmen Paneli
            else if (screenId === 'teacher-panel') {
                if (userData) {
                    currentUserId = userData.adSoyad; // Şimdilik ad soyad
                    currentUserName = userData.adSoyad;
                    currentUserRole = 'ogretmen';
                    
                    document.getElementById('teacher-welcome-name').textContent = `Öğretmen: ${toTitleCaseTR(currentUserName)}`;
                    const tBelow = document.getElementById('teacher-welcome-name-below');
                    if (tBelow) tBelow.textContent = `Öğretmen: ${toTitleCaseTR(currentUserName)}`;
                    
                    document.getElementById('teacher-panel').classList.remove('hidden');
                    subscribeClassList();
                    subscribeStudents();
                    subscribeFavorites();

                    // Öğretmen paneli verilerini yükle (eğer varsa)
                    loadTeacherData(); 
                } else {
                    showScreen('auth-page');
                }
            }
            else { // auth-page
                 document.getElementById('auth-page').classList.remove('hidden');
            }
        }

        // --- Veri Yönetimi (Öğrenci/Veli) ---

        let allQuestionEntries = {}; // Seçili öğrenciye ait tüm soru verilerini tutar

        function loadInitialData() {
            const targetStudentId = currentStudentId; 
            if (!targetStudentId) {
                // showNotification("Veri çekmek için öğrenci ID'si bulunamadı.", 'error');
                console.warn("loadInitialData: Öğrenci ID'si yok (Öğretmen girişi olabilir).");
                return;
            }
            database.ref('users/sorular/' + targetStudentId).off('value');
            allQuestionEntries = {}; 
            database.ref('users/sorular/' + targetStudentId).on('value', (snapshot) => {
                allQuestionEntries = {}; 
                snapshot.forEach(dateSnap => {
                    const dateKey = dateSnap.key; // YYYY-MM-DD
                    allQuestionEntries[dateKey] = dateSnap.val();
                });
                updateStatistics();
                renderAllPanels(); 
            }, (errorObject) => {
                console.log('Veri çekme hatası: ' + errorObject.name);
                showNotification('Veri çekilirken hata oluştu.', 'error');
            });
        }
        
        // Veli ve Öğrenci Panellerindeki istatistikleri ortak güncelleme (GÜNCELLENDİ - İSTEK 1)
        function updateStatistics() {
            let totalCorrect = 0, totalQuestions = 0, todayTotal = 0, weeklyTotal = 0;
            // 'recentEntries' dizisi artık gerekli değil, kaldırıldı.

            const todayISO = new Date().toISOString().substring(0, 10);
            const today = new Date();
            const startOfWeek = new Date(today);
            startOfWeek.setHours(0,0,0,0);
            startOfWeek.setDate(today.getDate() - today.getDay() + (today.getDay() === 0 ? -6 : 1)); // Pazartesi

            for (const dateKey in allQuestionEntries) {
                const date = new Date(dateKey);
                date.setHours(0,0,0,0);
                const dailyData = allQuestionEntries[dateKey];
                let dailyCorrect = 0, dailyTotal = 0;
                
                for (const subject in dailyData) {
                    dailyCorrect += dailyData[subject].d;
                    dailyTotal += dailyData[subject].d + dailyData[subject].y;
                    if (dateKey === todayISO) { 
                        todayTotal += dailyData[subject].d + dailyData[subject].y;
                    }
                    // 'recentEntries.push' satırı kaldırıldı.
                }
                if (date >= startOfWeek && date <= today) { weeklyTotal += dailyTotal; }
                totalCorrect += dailyCorrect;
                totalQuestions += dailyTotal;
            }
            const successRate = (totalQuestions > 0) ? Math.round((totalCorrect / totalQuestions) * 100) : 0;

            // Öğrenci Panelini Güncelle
            if (currentUserRole === 'ogrenci') {
                
                // --- İSTEK 1 GÜNCELLEMESİ BAŞLANGIÇ ---
                // Başlığı günün adıyla değiştir
                const dayName = today.toLocaleDateString('tr-TR', { weekday: 'long' });
                const titleEl = document.getElementById('today-entries-title');
                if(titleEl) titleEl.textContent = `${dayName} Raporu`;

                // Sadece bugünün verilerini hazırla
                const todaysEntriesList = [];
                const todaysData = allQuestionEntries[todayISO];
                if (todaysData) {
                    // Verileri ders ders işle (zaten toplanmış haldeler)
                    for (const subject in todaysData) {
                        todaysEntriesList.push({
                            ders: subject,
                            d: todaysData[subject].d,
                            y: todaysData[subject].y,
                            toplam: todaysData[subject].d + todaysData[subject].y
                        });
                    }
                }
                // --- İSTEK 1 GÜNCELLEMESİ SON ---

                document.getElementById('stat-bugun').textContent = todayTotal;
                document.getElementById('stat-haftalik').textContent = weeklyTotal;
                document.getElementById('stat-basari').textContent = `${successRate}%`;
                
                // renderRecentEntriesTable fonksiyonunu yeni listeyle çağır
                renderRecentEntriesTable(todaysEntriesList, 'son-eklenenler-body');
            }

            // Veli Panelini Güncelle
            if (currentUserRole === 'veli') {
                document.getElementById('parent-stat-total').textContent = totalQuestions;
                document.getElementById('parent-stat-weekly').textContent = `${weeklyTotal} Soru`;
                document.getElementById('parent-stat-success').textContent = `${successRate}%`;
                document.getElementById('parent-stat-pending').textContent = `0`;
                renderParentSummaryTable();
            }
        }
        
        // (GÜNCELLENDİ - İSTEK 1)
        function renderRecentEntriesTable(entries, tbodyId) {
            const tbody = document.getElementById(tbodyId);
            if (!tbody) return;
            tbody.innerHTML = '';
            if (entries.length === 0) {
                 // Mesaj güncellendi
                 tbody.innerHTML = '<tr><td colspan="4" class="py-3 px-3 text-center text-gray-400">Bugün henüz veri girilmedi.</td></tr>';
                 return;
            }
            entries.forEach(entry => {
                const row = document.createElement('tr');
                // Tarih bilgisi kaldırıldı, sadece ders adı
                row.innerHTML = `
                    <td class="py-3 px-3 text-sm">${entry.ders}</td>
                    <td class="py-3 px-3 text-center text-green-400">${entry.d}</td>
                    <td class="py-3 px-3 text-center text-red-400">${entry.y}</td>
                    <td class="py-3 px-3 text-center font-medium">${entry.toplam}</td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function renderParentSummaryTable() {
            const tbody = document.getElementById('parent-ders-tablosu-body');
            if (!tbody) return;
            const subjectTotals = {}; 
            for (const dateKey in allQuestionEntries) {
                const dailyData = allQuestionEntries[dateKey];
                for (const subject in dailyData) {
                    const entry = dailyData[subject];
                    if (!subjectTotals[subject]) { subjectTotals[subject] = { d: 0, y: 0, total: 0 }; }
                    subjectTotals[subject].d += entry.d;
                    subjectTotals[subject].y += entry.y;
                    subjectTotals[subject].total += (entry.d + entry.y);
                }
            }
            tbody.innerHTML = '';
            let hasData = false;
            allSubjectsFull.forEach(subjectName => {
                const data = subjectTotals[subjectName];
                if (data && data.total > 0) {
                    hasData = true;
                    const successRate = Math.round((data.d / data.total) * 100);
                    let successClass = 'text-red-400';
                    if (successRate >= 85) successClass = 'text-green-400';
                    else if (successRate >= 70) successClass = 'text-yellow-400';
                    const row = document.createElement('tr');
                    row.className = 'ders-row hover:bg-black hover:bg-opacity-10 transition-colors';
                    row.innerHTML = `
                        <td class="ders-adi py-4 px-6 font-medium text-white">${subjectName}</td>
                        <td class="ders-toplam py-4 px-6 text-gray-200">${data.total}</td>
                        <td class="ders-dogru py-4 px-6 text-green-400">${data.d}</td>
                        <td class="ders-yanlis py-4 px-6 text-red-400">${data.y}</td>
                        <td class="ders-basari py-4 px-6 ${successClass} font-medium">${successRate}%</td>
                        <td class="py-4 px-6"><button class="bg-purple-600 hover:bg-purple-700 text-white text-xs font-bold py-1.5 px-3 rounded-full transition-all">Detay Gör</button></td>
                    `;
                    tbody.appendChild(row);
                }
            });
            if (!hasData) {
                tbody.innerHTML = '<tr><td colspan="6" class="py-4 px-6 text-center text-gray-400">Çocuğunuz bu ay henüz soru çözümü kaydetmedi.</td></tr>';
            }
        }
        
        function renderAllPanels() {
            if (currentUserRole === 'ogrenci') {
                const activeTabId = document.querySelector('.student-panel-tab-button.bg-purple-600')?.dataset.tab || 'soru-girisi';
                if (activeTabId === 'gunluk-rapor') setupCalendar('student');
                else if (activeTabId === 'haftalik-rapor') setupWeeklyReport('student');
                else if (activeTabId === 'aylik-rapor') setupMonthlyReport('student');
            } else if (currentUserRole === 'veli') {
                const activeTabId = document.querySelector('.parent-panel-tab-button.bg-purple-600')?.dataset.tab || 'parent-genel-ozet';
                if (activeTabId === 'parent-genel-ozet') { renderParentSummaryTable(); } 
                else if (activeTabId === 'parent-gunluk-rapor') { setupCalendar('parent'); } 
                else if (activeTabId === 'parent-haftalik-rapor') { setupWeeklyReport('parent'); } 
                else if (activeTabId === 'parent-aylik-rapor') { setupMonthlyReport('parent'); }
            }
            // Öğretmen paneli render fonksiyonları zaten setupTeacherPanel içinde çağrılıyor.
        }

        // --- Takvim Mantığı (Ortak - Öğrenci/Veli) ---
        let calendarInstances = {}; 
        function setupCalendar(prefix) {
            const calendarGrid = document.getElementById(`${prefix}-calendar-grid`);
            const monthYearEl = document.getElementById(`${prefix}-month-year`);
            const prevMonthBtn = document.getElementById(`${prefix}-prev-month`);
            const nextMonthBtn = document.getElementById(`${prefix}-next-month`);
            const dailyDetails = document.getElementById(`${prefix}-daily-details`);
            const detailsTitle = document.getElementById(`${prefix}-details-title`);
            const detailsTableBody = document.getElementById(`${prefix}-details-table-body`);
            if (!calendarGrid || !monthYearEl) return; 
            if (!calendarInstances[prefix]) {
                const listenerDate = new Date();
                prevMonthBtn.addEventListener('click', () => { listenerDate.setMonth(listenerDate.getMonth() - 1); renderCalendar(listenerDate, prefix); });
                nextMonthBtn.addEventListener('click', () => { listenerDate.setMonth(listenerDate.getMonth() + 1); renderCalendar(listenerDate, prefix); });
                calendarInstances[prefix] = { date: listenerDate, selectedDayElement: null };
            }
            function renderCalendar(date, currentPrefix) {
                calendarGrid.innerHTML = '';
                dailyDetails.classList.add('hidden'); 
                calendarInstances[currentPrefix].selectedDayElement = null; 
                const year = date.getFullYear(), month = date.getMonth(); 
                monthYearEl.textContent = `${monthNames[month]} ${year}`;
                const firstDayOfMonth = new Date(year, month, 1).getDay(); 
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                let startOffset = (firstDayOfMonth === 0) ? 6 : firstDayOfMonth - 1; 
                const daysInPrevMonth = new Date(year, month, 0).getDate();
                for (let i = 0; i < startOffset; i++) {
                    const day = daysInPrevMonth - startOffset + i + 1;
                    calendarGrid.appendChild(createDayCell(day, true, false, null));
                }
                for (let i = 1; i <= daysInMonth; i++) {
                    const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                    const hasEntry = allQuestionEntries.hasOwnProperty(dateString); 
                    calendarGrid.appendChild(createDayCell(i, false, hasEntry, dateString, currentPrefix, date));
                }
                const totalCells = 42;
                const cellsRendered = startOffset + daysInMonth;
                const remainingCells = totalCells - cellsRendered;
                for (let i = 1; i <= remainingCells; i++) {
                    calendarGrid.appendChild(createDayCell(i, true, false, null));
                }
            }
            function createDayCell(day, isOtherMonth, hasEntry, dateString, currentPrefix, monthDate) {
                const cell = document.createElement('div');
                cell.className = 'day-cell';
                if (isOtherMonth) cell.classList.add('other-month');
                if (hasEntry) cell.classList.add('has-entry');
                const content = document.createElement('div');
                content.className = 'day-cell-content';
                content.textContent = day;
                cell.appendChild(content);
                if (!isOtherMonth) {
                    cell.addEventListener('click', () => handleDayClick(cell, dateString, day, currentPrefix, monthDate));
                }
                return cell;
            }
            function handleDayClick(cellElement, dateString, day, currentPrefix, monthDate) {
                let selectedEl = calendarInstances[currentPrefix].selectedDayElement;
                if (selectedEl) { selectedEl.classList.remove('selected'); }
                cellElement.classList.add('selected');
                calendarInstances[currentPrefix].selectedDayElement = cellElement;
                const entries = allQuestionEntries[dateString]; 
                const dayFormatted = `${day} ${monthNames[monthDate.getMonth()]} ${monthDate.getFullYear()}`;
                detailsTitle.textContent = `${dayFormatted} - Soru Detayları`;
                detailsTableBody.innerHTML = ''; 
                if (entries) {
                    for (const ders in entries) {
                        const entry = entries[ders];
                        const row = document.createElement('tr');
                        const total = entry.d + entry.y;
                        row.innerHTML = `
                            <td class="py-3 px-3">${ders}</td>
                            <td class="py-3 px-3 text-center text-green-400">${entry.d}</td>
                            <td class="py-3 px-3 text-center text-red-400">${entry.y}</td>
                            <td class="py-3 px-3 text-center font-medium">${total}</td>
                        `;
                        detailsTableBody.appendChild(row);
                    }
                } 
                if (!entries || Object.keys(entries).length === 0) {
                    detailsTableBody.innerHTML = `<tr><td colspan="4" class="py-3 px-3 text-center text-gray-400">Bu gün için soru girişi bulunamadı.</td></tr>`;
                }
                dailyDetails.classList.remove('hidden');
            }
            renderCalendar(calendarInstances[prefix].date, prefix);
        }

        // --- Haftalık Rapor Mantığı (Ortak - Öğrenci/Veli) ---
        let weeklyChartInstance = {}; 
        function getWeekLabel(date) {
    // UTC tabanlı hafta etiketi (Pazartesi başlangıç)
    const d = new Date(date);
    const baseUTC = new Date(Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate()));
    const dow = baseUTC.getUTCDay(); // 0=PAZ, 1=PZT
    const diff = (dow === 0 ? -6 : 1 - dow); // Pazartesiye kaydır
    const firstDayUTC = new Date(baseUTC);
    firstDayUTC.setUTCDate(firstDayUTC.getUTCDate() + diff);
    const lastDayUTC = new Date(firstDayUTC);
    lastDayUTC.setUTCDate(lastDayUTC.getUTCDate() + 6);
    // Etiketi yerel dilde gösterelim
    const options = { day: 'numeric', month: 'short' };
    return `${new Date(firstDayUTC).toLocaleDateString('tr-TR', options)} - ${new Date(lastDayUTC).toLocaleDateString('tr-TR', options)}`;
}
        function getWeeklyData(weekStartDate) {
    // weekStartDate: 'YYYY-MM-DD' (UTC gün sınırında)
    const data = {};
    const start = new Date(weekStartDate + 'T00:00:00Z'); // UTC başlat
    for (let i = 0; i < 7; i++) {
        const day = new Date(start);
        day.setUTCDate(start.getUTCDate() + i); // UTC gün ekle
        const dateKey = day.toISOString().substring(0, 10); // UTC 'YYYY-MM-DD'
        const dailyEntries = allQuestionEntries[dateKey];
        allSubjectsFull.forEach(ders => {
            if (!data[ders]) data[ders] = [];
            while (data[ders].length < i) { data[ders].push({d: 0, y: 0}); }
            const entry = (dailyEntries && dailyEntries[ders]) ? dailyEntries[ders] : {d: 0, y: 0};
            data[ders].push(entry);
        });
    }
    return data;
}
        function setupWeeklyReport(prefix) {
            const chartType = (prefix === 'student' || prefix === 'parent' || prefix === 'tsr') ? 'bar' : 'line';

    // Helper to style weekly dataset according to chart type
    function getWeeklyDataset(chartType, dataArr) {
  const base = { label: 'Toplam Soru', data: dataArr };
  if (chartType === 'bar') {
    return { ...base,
      backgroundColor: 'rgba(168, 85, 247, 0.7)',
      borderColor: 'rgba(192, 132, 252, 1)',
      borderWidth: 1,
      borderRadius: 10
    };
  } else {
    return { ...base,
      borderColor: '#a855f7',
      backgroundColor: 'rgba(168, 85, 247, 0.1)',
      fill: true,
      tension: 0.3
    };
  }
}
        const weekSelectEl = document.getElementById(`${prefix}-week-select`);
            const weeklyChartCanvasEl = document.getElementById(`${prefix}-weekly-chart-canvas`);
            const weeklyDetailsBodyEl = document.getElementById(`${prefix}-weekly-details-body`);
            if (!weekSelectEl || !weeklyChartCanvasEl || !weeklyDetailsBodyEl) return;
            function populateWeekSelector() {
    // UTC tabanlı "Bu Hafta" ve önceki haftalar (Pazartesi başlangıç)
    const today = new Date();
    weekSelectEl.innerHTML = '';
    for (let i = 0; i < 4; i++) {
        const option = document.createElement('option');
        // Bugünden UTC olarak i hafta geriye git
        const baseUTC = new Date(Date.UTC(today.getUTCFullYear(), today.getUTCMonth(), today.getUTCDate()));
        baseUTC.setUTCDate(baseUTC.getUTCDate() - (i * 7));
        // Bu haftanın UTC Pazartesisi
        const dow = baseUTC.getUTCDay();
        const diff = (dow === 0 ? -6 : 1 - dow);
        const startOfWeekUTC = new Date(baseUTC);
        startOfWeekUTC.setUTCDate(startOfWeekUTC.getUTCDate() + diff);
        option.value = startOfWeekUTC.toISOString().substring(0, 10); // 'YYYY-MM-DD' (UTC)
        const label = (i === 0) ? "Bu Hafta" : (i === 1) ? "Geçen Hafta" : `${i} Hafta Önce`;
        option.textContent = `${label} (${getWeekLabel(startOfWeekUTC)})`;
        weekSelectEl.appendChild(option);
    }
}
            function renderWeeklyReport(weekStartDate) {
                const data = getWeeklyData(weekStartDate); 
                const dailyTotals = { toplam: [0,0,0,0,0,0,0] };
                allSubjectsFull.forEach(subjectName => { 
                    const subjectData = data[subjectName] || []; 
                    for(let i=0; i < 7; i++) { 
                        const dayData = subjectData[i] || {d: 0, y: 0};
                        dailyTotals.toplam[i] += (dayData.d + dayData.y); 
                    }
                });
                if (weeklyChartInstance[prefix]) { weeklyChartInstance[prefix].destroy(); }
                const ctx = weeklyChartCanvasEl.getContext('2d');
                if (!ctx) return; 
                weeklyChartInstance[prefix] = new Chart(ctx, {
                    type: chartType,
                    data: {
                        labels: daysOfWeekShort,
                        datasets: [getWeeklyDataset(chartType, dailyTotals.toplam)]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false, 
                        plugins: { legend: { labels: { color: '#d1d5db' } } },
                        scales: { y: { beginAtZero: true, ticks: { color: '#9ca3af' } }, x: { ticks: { color: '#9ca3af' } } }
                    }
                });
                weeklyDetailsBodyEl.innerHTML = ''; 
                let totalQuestionsForAllSubjects = 0;
                allSubjectsFull.forEach(subjectName => { 
                    const subjectShortName = allSubjectsMap[subjectName]; 
                    const row = document.createElement('tr');
                    let rowHTML = `<td class="py-3 px-3 text-sm font-medium sticky left-0 z-10" style="background-color: rgba(30, 41, 59, 0.5); backdrop-filter: blur(10px);">${subjectShortName}</td>`;
                    let totalWeekQuestions = 0;
                    const subjectData = data[subjectName] || []; 
                    for(let i=0; i < 7; i++) {
                        const dayData = subjectData[i] || {d: 0, y: 0};
                        const dayTotal = dayData.d + dayData.y;
                        totalWeekQuestions += dayTotal;
                        let cellClass = (dayTotal > 0) ? 'text-gray-200 font-medium' : 'text-gray-600';
                        rowHTML += `<td class="py-3 px-3 text-center text-sm ${cellClass}">${dayTotal}</td>`;
                    }
                    totalQuestionsForAllSubjects += totalWeekQuestions;
                    rowHTML += `<td class="py-3 px-3 text-center text-sm font-bold text-purple-300">${totalWeekQuestions}</td>`;
                    
row.innerHTML = rowHTML;
weeklyDetailsBodyEl.appendChild(row);

                });
                
if (weeklyDetailsBodyEl.children.length === 0) {
    weeklyDetailsBodyEl.innerHTML = '<tr><td colspan="9" class="py-3 px-3 text-center text-gray-400">Bu hafta için veri bulunamadı.</td></tr>';
}

            }
            if (!weekSelectEl.hasAttribute('data-listeners-attached')) {
                populateWeekSelector();
                weekSelectEl.addEventListener('change', (e) => renderWeeklyReport(e.target.value));
                if(weekSelectEl.value) { renderWeeklyReport(weekSelectEl.value); }
                weekSelectEl.setAttribute('data-listeners-attached', true);
            } else {
                 populateWeekSelector();
                 if(weekSelectEl.value) { renderWeeklyReport(weekSelectEl.value); }
            }
        }

        // --- Aylık Rapor Mantığı (Ortak - Öğrenci/Veli) ---
        // (GÜNCELLENDİ - İSTEK 2)
        let monthlyChartInstance = {};
        function getMonthlyData(yearMonth) { // "YYYY-MM"
            const data = {};
            for (const dateKey in allQuestionEntries) {
                if (dateKey.startsWith(yearMonth)) {
                    const dailyEntries = allQuestionEntries[dateKey];
                    for (const ders in dailyEntries) {
                        const entry = dailyEntries[ders];
                        if (!data[ders]) { data[ders] = { d: 0, y: 0 }; }
                        data[ders].d += entry.d;
                        data[ders].y += entry.y;
                    }
                }
            }
            return data;
        }
        function setupMonthlyReport(prefix) {
            const monthInputEl = document.getElementById(`${prefix}-month-select`);
            const monthlyChartCanvasEl = document.getElementById(`${prefix}-monthly-chart-canvas`);
            const monthlyDetailsBodyEl = document.getElementById(`${prefix}-monthly-details-body`);
            if (!monthInputEl || !monthlyChartCanvasEl || !monthlyDetailsBodyEl) return;
            const today = new Date();
            const currentMonthISO = today.toISOString().substring(0, 7);
            monthInputEl.value = currentMonthISO;
            function renderMonthlyReport(monthId) { // monthId formatı: "YYYY-MM"
                const data = getMonthlyData(monthId);
                const chartLabels = [], chartTotalData = [];
                let tableHTML = '';
                let totalQuestionsForMonth = 0;

                // --- İSTEK 2 GÜNCELLEMESİ BAŞLANGIÇ ---
                // 'if (total > 0)' kontrolü kaldırıldı, tüm dersler döngüye alınıyor
                allSubjectsFull.forEach(subjectName => {
                    const subjectData = data[subjectName] || { d: 0, y: 0 };
                    const total = subjectData.d + subjectData.y;
                    const successRate = (total > 0) ? Math.round((subjectData.d / total) * 100) : 0;
                    totalQuestionsForMonth += total;

                    // Grafiğe her zaman ekle
                    chartLabels.push(allSubjectsMap[subjectName]);
                    chartTotalData.push(total);
                    
                    // 0 olan veriler için stil belirle
                    let successClass = 'text-gray-500'; // 0 için varsayılan
                    if (total > 0) {
                        if (successRate >= 80) successClass = 'text-green-400';
                        else if (successRate >= 60) successClass = 'text-yellow-400';
                        else successClass = 'text-red-400';
                    }
                    
                    // Tabloya her zaman ekle
                    tableHTML += `
                        <tr>
                            <td class="py-3 px-3 font-medium">${subjectName}</td>
                            <td class="py-3 px-3 text-center font-bold ${total > 0 ? 'text-purple-300' : 'text-gray-500'}">${total}</td>
                            <td class="py-3 px-3 text-center ${total > 0 ? 'text-green-400' : 'text-gray-500'}">${subjectData.d}</td>
                            <td class="py-3 px-3 text-center ${total > 0 ? 'text-red-400' : 'text-gray-500'}">${subjectData.y}</td>
                            <td class="py-3 px-3 text-center font-medium ${successClass}">${total > 0 ? successRate + '%' : '-'}</td>
                        </tr>
                    `;
                });
                // --- İSTEK 2 GÜNCELLEMESİ SON ---
                
                monthlyDetailsBodyEl.innerHTML = tableHTML;
                
                if (monthlyChartInstance[prefix]) { monthlyChartInstance[prefix].destroy(); }
                const ctx = monthlyChartCanvasEl.getContext('2d');
                if (!ctx) return;
                monthlyChartInstance[prefix] = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: chartLabels,
                        datasets: [{ label: 'Toplam Soru', data: chartTotalData, backgroundColor: 'rgba(168, 85, 247, 0.7)', borderColor: 'rgba(192, 132, 252, 1)', borderWidth: 1, borderRadius: 5 }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: { y: { beginAtZero: true, ticks: { color: '#9ca3af' } }, x: { ticks: { color: '#9ca3af' } } }
                    }
                });
            }
            if (!monthInputEl.hasAttribute('data-listeners-attached')) {
                monthInputEl.addEventListener('change', (e) => renderMonthlyReport(e.target.value));
                monthInputEl.setAttribute('data-listeners-attached', true);
            }
            renderMonthlyReport(monthInputEl.value);
        }

        // --- Veli Paneli Gemini Özeti Mantığı ---
        const loadingModal = document.getElementById('loadingModal');
        const resultModal = document.getElementById('geminiResultModal');
        const resultContent = document.getElementById('geminiResultContent');
        const closeGeminiModal = document.getElementById('closeGeminiModal');
        const closeGeminiModalBtn = document.getElementById('closeGeminiModalBtn');
        const getSummaryButton = document.getElementById('getGeminiSummary');
        const showModal = (modal) => modal.style.display = 'block';
        const hideModal = (modal) => modal.style.display = 'none';
        if(closeGeminiModal) closeGeminiModal.onclick = () => hideModal(resultModal);
        if(closeGeminiModalBtn) closeGeminiModalBtn.onclick = () => hideModal(resultModal);
        function scrapeDashboardData() {
            let data = `Çocuğumun (${document.getElementById('parent-welcome-student-info').textContent}) güncel soru takip verileri aşağıdadır:\n\n`;
            data += "### Genel İstatistikler\n";
            data += `- Toplam Çözülen Soru: ${document.getElementById('parent-stat-total')?.textContent}\n`;
            data += `- Haftalık İlerleme: ${document.getElementById('parent-stat-weekly')?.textContent}\n`;
            data += `- Genel Başarı Oranı: ${document.getElementById('parent-stat-success')?.textContent}\n\n`;
            data += "### Ders Bazlı Başarı\n";
            document.querySelectorAll('#parent-ders-tablosu-body tr').forEach(row => {
                const cells = row.querySelectorAll('td');
                if(cells.length > 3) {
                    const ders = cells[0]?.textContent;
                    const basari = cells[4]?.textContent;
                    const toplam = cells[1]?.textContent;
                    if (toplam !== '0') { data += `- ${ders} (Toplam ${toplam} Soru): Başarı ${basari}\n`; }
                }
            });
            data += "\n### Öğretmen Notları (ÖRNEK VERİ)\n";
            data += `Notlar henüz Firebase'den çekilmedi. Özet veriyi temel alınız.\n`;
            return data;
        }
        async function callGeminiAPI(scrapedData, maxRetries = 3) {
            const apiKey = ""; // API Anahtarınız (Veli paneli Gemini için)
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;
            const systemPrompt = `
                Sen bir tecrübeli ve motive edici bir eğitim danışmanısın.
                Bir veli, çocuğunun soru takip programı verilerini seninle paylaşıyor.
                Veliye, çocuğunun durumu hakkında (hem olumlu hem de gelişime açık yönler) kısa bir özet sun.
                Ardından, evde nasıl destek olabileceklerine dair 2-3 adet uygulanabilir, basit ve motive edici ipucu ver.
                Cevabın mutlaka Türkçe, kısa, net ve cesaretlendirici olmalı.
                Markdown formatında (başlıklar, listeler, kalın yazılar) cevap ver.
                Başlık için '### Başlık' kullan. Liste için '* Madde' kullan. Kalın için '**kelime**' kullan.
            `;
            const payload = { contents: [{ parts: [{ text: scrapedData }] }], systemInstruction: { parts: [{ text: systemPrompt }] }, };
            let attempt = 0;
            while (attempt < maxRetries) {
                try {
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) {
                        if (response.status === 429 || response.status >= 500) { throw new Error(`HTTP error ${response.status}`); } 
                        else { const errorData = await response.json(); throw new Error(`API Hatası: ${errorData.error.message}`); }
                    }
                    const result = await response.json();
                    if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts[0].text) {
                        return result.candidates[0].content.parts[0].text;
                    } else { throw new Error("API'den geçerli bir yanıt alınamadı."); }
                } catch (error) {
                    console.warn(`Attempt ${attempt + 1} failed: ${error.message}`);
                    attempt++;
                    if (attempt >= maxRetries) { throw new Error(`API'ye ulaşılamıyor: ${error.message}`); }
                    const delay = Math.pow(2, attempt - 1) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }
        function formatGeminiResponse(text) {
            return text
                .replace(/### (.*?)\n/g, '<h3>$1</h3>') 
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\* (.*?)\n/g, '<ul><li>$1</li></ul>')
                .replace(/<\/ul>\s*<ul>/g, '')
                .replace(/\n/g, '<br>');
        }
        

        // --- YENİ: ÖĞRETMEN PANELİ FONKSİYONLARI ---
        
        
        // === ÖĞRETMEN PANELİ GENEL ÖZET: Firebase'den canlı veri ===
        let teacherStudents = {};   // users/ogrenciler
        let teacherSorular = {};    // users/sorular
        let teacherDataListenersStarted = false;

        

        

// --- /ÖĞRETMEN PANELİ FONKSİYONLARI SONU ---

        // ---------------------------------------------
        // ** ANA DOM YÜKLEME OLAYLARI **
        // ---------------------------------------------
        
        document.addEventListener('DOMContentLoaded', function() {

            showScreen('auth-page');
            setupTeacherPanel(); // YENİ: Öğretmen paneli dinleyicilerini kur

            // --- İSTEK 3: Kayıtlı bilgileri yükle (BURAYA EKLENDİ) ---
            function loadSavedCredentials() {
                // Öğrenci
                if (localStorage.getItem('remember_ogrenci_check') === 'true') {
                    document.getElementById('login-ogrenci-no').value = localStorage.getItem('remember_ogrenci_id') || '';
                    document.getElementById('login-sifre').value = localStorage.getItem('remember_ogrenci_pass') || '';
                    document.getElementById('remember-ogrenci').checked = true;
                }
                // Veli
                if (localStorage.getItem('remember_veli_check') === 'true') {
                    document.getElementById('veli-login-ogrenci-no').value = localStorage.getItem('remember_veli_id') || '';
                    document.getElementById('veli-login-sifre').value = localStorage.getItem('remember_veli_pass') || '';
                    document.getElementById('remember-veli').checked = true;
                }
                // Öğretmen
                if (localStorage.getItem('remember_ogretmen_check') === 'true') {
                    document.getElementById('ogretmen-login-ad').value = localStorage.getItem('remember_ogretmen_id') || '';
                    document.getElementById('ogretmen-login-kod').value = localStorage.getItem('remember_ogretmen_pass') || '';
                    document.getElementById('remember-ogretmen').checked = true;
                }
            }
            loadSavedCredentials();
            // --- /İSTEK 3 ---

            // --- A. Giriş/Kayıt Sekme Mantığı (index.html) ---
            const tabs = document.querySelectorAll('#auth-page .tab-button'); // Seçici özelleştirildi
            const contents = document.querySelectorAll('#auth-page .tab-content'); // Seçici özelleştirildi
            const activeTabClasses = ['bg-purple-600', 'text-white', 'shadow-md'];
            const inactiveTabClasses = ['text-gray-300', 'hover:text-white', 'hover:bg-white', 'hover:bg-opacity-10'];

            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(item => { item.classList.remove(...activeTabClasses); item.classList.add(...inactiveTabClasses); });
                    tab.classList.add(...activeTabClasses); tab.classList.remove(...inactiveTabClasses);
                    contents.forEach(content => content.classList.remove('active'));
                    const targetContent = document.getElementById(tab.dataset.tab);
                    if (targetContent) { targetContent.classList.add('active'); }
                });
            });
            if (tabs.length > 0) {
                tabs[0].classList.add(...activeTabClasses); tabs[0].classList.remove(...inactiveTabClasses);
                if (contents.length > 0) contents[0].classList.add('active');
            }

            // --- B. Firebase Giriş ve Kayıt İşlemleri ---
            
            // B.1. Öğrenci Kayıt
            document.getElementById('ogrenci-register-form')?.addEventListener('submit', function(e) {
                e.preventDefault(); 
                const ogrenciNo = document.getElementById('reg-ogrenci-no').value.trim();
                const ad = document.getElementById('reg-ad').value.trim();
                const soyad = document.getElementById('reg-soyad').value.trim();
                const sinif = document.getElementById('sinif-select-register').value;
                const sifre = document.getElementById('reg-sifre').value;
                const sifreTekrar = document.getElementById('reg-sifre-tekrar').value;
                if (sifre !== sifreTekrar) { showNotification("Şifreler eşleşmiyor!", 'error'); return; }
                if (sinif === "") { showNotification("Lütfen sınıfınızı seçin!", 'error'); return; }
                if (!ogrenciNo || !ad || !soyad) { showNotification("Lütfen tüm alanları doldurun.", 'error'); return; }
                database.ref('users/ogrenciler/' + ogrenciNo).once('value')
                    .then(snapshot => {
                        if (snapshot.exists()) { throw new Error(`Hata: ${ogrenciNo} numaralı öğrenci zaten kayıtlı!`); }
                        const ogrenciData = { ad: ad, soyad: soyad, sinif: sinif, sifre: sifre, rol: 'ogrenci', kayitTarihi: new Date().toISOString() };
                        return database.ref('users/ogrenciler/' + ogrenciNo).set(ogrenciData);
                    })
                    .then(() => { showNotification("Öğrenci Kaydı Başarılı! Artık giriş yapabilirsiniz.", 'success'); e.target.reset(); })
                    .catch((error) => { showNotification(error.message, 'error'); });
            });

            // B.2. Veli Kayıt
            document.getElementById('veli-register-form')?.addEventListener('submit', function(e) {
                e.preventDefault(); 
                const ad = document.getElementById('veli-reg-ad').value.trim();
                const soyad = document.getElementById('veli-reg-soyad').value.trim();
                const ogrenciNo = document.getElementById('veli-reg-ogrenci-no').value.trim();
                const sifre = document.getElementById('veli-reg-sifre').value;
                const sifreTekrar = document.getElementById('veli-reg-sifre-tekrar').value;
                if (sifre !== sifreTekrar) { showNotification("Şifreler eşleşmiyor!", 'error'); return; }
                if (!ogrenciNo || !ad || !soyad) { showNotification("Lütfen tüm alanları doldurun.", 'error'); return; }
                const veliId = `veli-${ogrenciNo}`;
                database.ref('users/ogrenciler/' + ogrenciNo).once('value')
                    .then(studentSnapshot => {
                        if (!studentSnapshot.exists()) { throw new Error(`Öğrenci bulunamadı.`); }
                        const studentData = studentSnapshot.val();
                        return database.ref('users/veliler/' + veliId).once('value')
                            .then(veliSnapshot => {
                                if (veliSnapshot.exists()) { throw new Error("Veli hesabı zaten mevcut."); }
                                const veliData = {
                                    ad: ad, soyad: soyad, cocukOgrenciNo: ogrenciNo, sifre: sifre, rol: 'veli', kayitTarihi: new Date().toISOString(),
                                    cocukAd: studentData.ad, cocukSoyad: studentData.soyad, cocukSinif: studentData.sinif
                                };
                                return database.ref('users/veliler/' + veliId).set(veliData);
                            })
                    })
                    .then(result => {
                        if (result !== undefined) { 
                            showNotification("Veli Kaydı Başarılı! Artık veli girişi yapabilirsiniz.", 'success'); e.target.reset(); 
                        }
                    })
                    .catch((error) => {
                        if (error.message === "Öğrenci bulunamadı.") { showNotification(`Hata: ${ogrenciNo} numaralı öğrenci bulunamadı.`, 'error'); }
                        else if (error.message === "Veli hesabı zaten mevcut.") { showNotification(`Hata: Bu öğrenci numarası için zaten bir veli hesabı kayıtlı.`, 'error'); }
                        else { showNotification("Kayıt Hatası: " + error.message, 'error'); }
                    });
            });

            // B.3. Öğrenci Girişi (GÜNCELLENDİ - İSTEK 3)
            document.getElementById('ogrenci-login-form')?.addEventListener('submit', function(e) {
                e.preventDefault();
                const ogrenciNo = document.getElementById('login-ogrenci-no').value.trim();
                const sifre = document.getElementById('login-sifre').value;
                const remember = document.getElementById('remember-ogrenci').checked; // EKLENDİ
                
                database.ref('users/ogrenciler/' + ogrenciNo).once('value')
                    .then(snapshot => {
                        if (snapshot.exists()) {
                            const userData = snapshot.val();
                            if (userData.sifre === sifre) {
                                // --- İSTEK 3 KONTROLÜ EKLENDİ ---
                                if (remember) {
                                    saveLogin('ogrenci', ogrenciNo, sifre);
                                } else {
                                    clearLogin('ogrenci');
                                }
                                // --- /İSTEK 3 ---
                                showNotification(`Başarılı: Sayın ${userData.ad} ${userData.soyad}, sisteme hoş geldiniz!`, 'success', 3000);
                                userData.ogrenciNo = ogrenciNo;
                                showScreen('student-panel', userData); 
                                // Formu sadece hatırlama seçili değilse temizle
                                if (!remember) e.target.reset();
                            } else { showNotification("Hata: Şifre yanlış.", 'error'); }
                        } else { showNotification("Hata: Öğrenci Numarası bulunamadı.", 'error'); }
                    })
                    .catch(error => { showNotification("Giriş Hatası: " + error.message, 'error'); });
            });

            // B.4. Veli Girişi (GÜNCELLENDİ - İSTEK 3)
            document.getElementById('veli-login-form')?.addEventListener('submit', function(e) {
                e.preventDefault();
                const ogrenciNo = document.getElementById('veli-login-ogrenci-no').value.trim();
                const sifre = document.getElementById('veli-login-sifre').value;
                const remember = document.getElementById('remember-veli').checked; // EKLENDİ
                const veliId = `veli-${ogrenciNo}`;

                database.ref('users/veliler/' + veliId).once('value')
                    .then(snapshot => {
                        if (snapshot.exists()) {
                            const userData = snapshot.val();
                            if (userData.sifre === sifre) {
                                // --- İSTEK 3 KONTROLÜ EKLENDİ ---
                                if (remember) {
                                    saveLogin('veli', ogrenciNo, sifre);
                                } else {
                                    clearLogin('veli');
                                }
                                // --- /İSTEK 3 ---
                                showNotification(`Başarılı: Sayın Veli ${userData.ad} ${userData.soyad}, sisteme hoş geldiniz!`, 'success', 3000);
                                userData.veliId = veliId;
                                showScreen('parent-panel', userData); 
                                if (!remember) e.target.reset();
                            } else { showNotification("Hata: Şifre yanlış.", 'error'); }
                        } else { showNotification("Hata: Bu öğrenci numarasına kayıtlı bir veli hesabı bulunamadı.", 'error'); }
                    })
                    .catch(error => { showNotification("Giriş Hatası: " + error.message, 'error'); });
            });

            // B.4.5. Öğretmen Girişi (GÜNCELLENDİ - İSTEK 3)
            document.getElementById('ogretmen-login-form')?.addEventListener('submit', function(e) {
                e.preventDefault();
                const adSoyad = document.getElementById('ogretmen-login-ad').value.trim();
                const kod = document.getElementById('ogretmen-login-kod').value.trim();
                const remember = document.getElementById('remember-ogretmen').checked; // EKLENDİ
                const GECERLI_KOD = "703501"; 

                if (adSoyad === "") {
                    showNotification("Lütfen adınızı ve soyadınızı girin.", 'error');
                    return;
                }
                if (kod === GECERLI_KOD) {
                    // --- İSTEK 3 KONTROLÜ EKLENDİ ---
                    if (remember) {
                        saveLogin('ogretmen', adSoyad, kod);
                    } else {
                        clearLogin('ogretmen');
                    }
                    // --- /İSTEK 3 ---
                    showNotification(`Giriş Başarılı! Hoş geldiniz, ${adSoyad}.`, 'success');
                    showScreen('teacher-panel', { adSoyad: adSoyad });
                    if (!remember) e.target.reset();
                } else {
                    showNotification("Hata: Girilen kod yanlış.", 'error');
                }
            });

            // B.5. Çıkış Yap Butonları (GÜNCELLENDİ)
            document.getElementById('student-logout-button')?.addEventListener('click', () => { showNotification("Başarıyla çıkış yapıldı.", 'info'); showScreen('auth-page'); });
            document.getElementById('parent-logout-button')?.addEventListener('click', () => { showNotification("Başarıyla çıkış yapıldı.", 'info'); showScreen('auth-page'); });
            document.getElementById('teacher-logout-button')?.addEventListener('click', () => { showNotification("Başarıyla çıkış yapıldı.", 'info'); showScreen('auth-page'); }); // YENİ
            
            // B.6. Role Select (Form değiştirme)
            document.getElementById('role-select')?.addEventListener('change', (e) => {
                const ogrenciFormDiv = document.getElementById('ogrenci-form');
                const veliFormDiv = document.getElementById('veli-form');
                if (e.target.value === 'ogrenci') {
                    ogrenciFormDiv.classList.remove('hidden'); veliFormDiv.classList.add('hidden');
                } else if (e.target.value === 'veli') {
                    ogrenciFormDiv.classList.add('hidden'); veliFormDiv.remove('hidden');
                }
            });

            // --- C. Öğrenci Paneli Soru Girişi Mantığı ---
            document.getElementById('soru-giris-form')?.addEventListener('submit', function(e) {
                e.preventDefault();
                const ders = document.getElementById('ders').value;
                const dogru = parseInt(document.getElementById('dogru').value) || 0;
                const yanlis = parseInt(document.getElementById('yanlis').value) || 0;
                const total = dogru + yanlis;
                if (currentUserRole !== 'ogrenci' || !currentUserId) { showNotification("Soru girişi için öğrenci olarak giriş yapmalısınız.", 'error'); return; }
                if (ders === "") { showNotification("Lütfen bir ders seçin.", 'error'); return; }
                if (total <= 0) { showNotification("En az bir soru çözülmüş olmalıdır.", 'error'); return; }
                const todayISO = new Date().toISOString().substring(0, 10);
                const refPath = `users/sorular/${currentUserId}/${todayISO}/${ders}`;
                database.ref(refPath).once('value')
                    .then(snapshot => {
                        const currentData = snapshot.val() || { d: 0, y: 0 };
                        const newData = { d: currentData.d + dogru, y: currentData.y + yanlis };
                        return database.ref(refPath).set(newData);
                    })
                    .then(() => {
                        showNotification(`${ders} için ${total} soru kaydedildi!`, 'success');
                        e.target.reset(); 
                        document.getElementById('dogru').value = 0;
                        document.getElementById('yanlis').value = 0;
                    })
                    .catch(error => { showNotification("Soru kaydında hata: " + error.message, 'error'); });
            });

            // --- D. Veli Paneli Gemini Özeti Mantığı ---
            if(getSummaryButton) {
                getSummaryButton.addEventListener('click', async () => {
                    if (currentUserRole !== 'veli' || !currentStudentId) {
                        showNotification("Bu özellik sadece veli panelinde kullanılabilir.", 'error'); return;
                    }
                    showModal(loadingModal);
                    try {
                        const promptData = scrapeDashboardData();
                        const responseText = await callGeminiAPI(promptData);
                        resultContent.innerHTML = formatGeminiResponse(responseText);
                        hideModal(loadingModal);
                        showModal(resultModal);
                    } catch (error) {
                        console.error('Gemini API Hatası:', error);
                        hideModal(loadingModal);
                        resultContent.innerHTML = `<p class="text-red-400"><strong>Hata:</strong> Analiz yüklenemedi. API Anahtarınızı kontrol edin veya daha sonra tekrar deneyin.</p><p class="text-xs text-gray-400">${error.message}</p>`;
                        showModal(resultModal);
                    }
                });
            }
            window.onclick = (event) => {
                if (event.target == resultModal) { hideModal(resultModal); }
            };

            // --- E. Panel Sekme Mantığı (Öğrenci/Veli) ---
            const studentPanelTabs = document.querySelectorAll('.student-panel-tab-button');
            const parentPanelTabs = document.querySelectorAll('.parent-panel-tab-button');
            const allPanelTabs = [...studentPanelTabs, ...parentPanelTabs];

            allPanelTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const isStudentTab = tab.classList.contains('student-panel-tab-button');
                    const tabsToClear = isStudentTab ? studentPanelTabs : parentPanelTabs;
                    const panelId = isStudentTab ? 'student-panel' : 'parent-panel';
                    tabsToClear.forEach(item => { item.classList.remove(...activeTabClasses); item.classList.add(...inactiveTabClasses); });
                    tab.classList.add(...activeTabClasses); tab.classList.remove(...inactiveTabClasses);
                    document.querySelectorAll(`#${panelId} .panel-tab-content`).forEach(content => content.classList.remove('active'));
                    const targetContent = document.getElementById(tab.dataset.tab);
                    if (targetContent) { 
                        targetContent.classList.add('active'); 
                        renderAllPanels(); 
                    }
                });
            });
            if (studentPanelTabs.length > 0) {
                studentPanelTabs[0].classList.add(...activeTabClasses);
                document.getElementById(studentPanelTabs[0].dataset.tab)?.classList.add('active');
            }
            if (parentPanelTabs.length > 0) {
                parentPanelTabs[0].classList.add(...activeTabClasses);
                document.getElementById(parentPanelTabs[0].dataset.tab)?.classList.add('active');
            }

        });
    

// === Öğretmen paneli (güncel) değişkenler ve fonksiyonlar (progres.html'den) ===
let studentsByClass = {};
let teacherFavorites = {};
let allStudentsMap = {};
const CLASSLIST_PATH = 'system/siniflar';
let classList = [];
const FAVORITES_PATH = 'system/favorites';

function titleTR(str) {
  if (!str) return '';
  return str
    .split(/\s+/)
    .map(function(word){
      return word
        .split('-')
        .map(function(part){
          if (part.length === 0) return part;
          return part.charAt(0).toLocaleUpperCase('tr-TR') + part.slice(1).toLocaleLowerCase('tr-TR');
        })
        .join('-');
    })
    .join(' ');
}

function subscribeStudents() {
  database.ref('users/ogrenciler').on('value', function(snap){
    const obj = snap.val() || {};
    const map = {};
    allStudentsMap = {}; // Haritayı sıfırla

    Object.keys(obj).forEach(function(ogrNo){
      const s = obj[ogrNo] || {};
      const sinif = s.sinif || '';
      const ad = titleTR(s.ad || '');
      const soyad = titleTR(s.soyad || '');
      
      // Sınıfa göre grupla
      if (!map[sinif]) map[sinif] = [];
      map[sinif].push({ no: ogrNo, ad: ad, soyad: soyad });
      
      // Tüm öğrenci haritasını doldur (Favoriler sekmesi için)
      allStudentsMap[ogrNo] = { ad: ad, soyad: soyad, sinif: sinif };
    });
    // Her sınıf içindeki öğrencileri okul numarasına göre sırala (artarak)
    Object.keys(map).forEach(function(k){
      map[k].sort(function(a,b){ return (''+a.no).localeCompare((''+b.no), 'tr'); });
    });
    studentsByClass = map;
    
    // Sınıf listesini yeniden çiz
    if (typeof window.renderTeacherClassList === 'function') {
      window.renderTeacherClassList();
    }
    // Favoriler sekmesini de yeniden çiz
    if (typeof window.renderFavoritesTab === 'function') {
        renderFavoritesTab();
    }
  });
}

function subscribeClassList() {
  database.ref(CLASSLIST_PATH).on('value', function(snap) {
    var obj = snap.val() || {};
    classList = Object.keys(obj).sort();

    // Öğretmen paneli "Sınıflar" sekmesini yeniden çiz
    if (typeof window.renderTeacherClassList === 'function') {
      window.renderTeacherClassList();
    }
    // Bu, Grafik güncellemelerini de tetikleyebilir (recomputeTeacherSummary içinde)
  });
}

function subscribeFavorites() {
    database.ref(FAVORITES_PATH).on('value', function(snap) {
        teacherFavorites = snap.val() || {};
        
        // DÜZELTME: YARIŞ DURUMU (RACE CONDITION) DÜZELTMESİ
        // Favoriler sekmesini sadece 'allStudentsMap' (tüm öğrenci bilgileri)
        // yüklendiyse yeniden çiz.
        if (Object.keys(allStudentsMap).length > 0) {
            if (typeof window.renderFavoritesTab === 'function') {
                renderFavoritesTab();
            }
        }
    });
}

function toggleFavorite(e) {
            try{ if(e) { e.stopImmediatePropagation?.(); e.stopPropagation?.(); } }catch(_){}
            var starButton = e.target.closest('.favorite-star');
            if (!starButton) return;
            var studentId = starButton.dataset.studentId;
            if (!studentId) return;
            var icon = starButton.querySelector('ion-icon');
            var isCurrentlyFavorited = starButton.classList.contains('favorited');
            var favRef = database.ref(`${FAVORITES_PATH}/${studentId}`);

            if (isCurrentlyFavorited) {
                favRef.remove();
                starButton.classList.remove('favorited');
                if (icon) icon.setAttribute('name', 'star-outline');
            } else {
                favRef.set(true); 
                starButton.classList.add('favorited', 'pop-animation');
                if (icon) icon.setAttribute('name', 'star');
                starButton.addEventListener('animationend', () => {
                    starButton.classList.remove('pop-animation');
                }, { once: true });
            }
        }

function renderFavoritesTab() {
            var container = document.getElementById('favorites-list-container');
            if (!container) return;
            container.innerHTML = '';
            var favoriteIds = Object.keys(teacherFavorites);

            if (favoriteIds.length === 0) {
                 container.innerHTML = '<p class="text-gray-400 italic">Favori öğrenci bulunamadı. Sınıf listesinden bir öğrencinin yanındaki yıldıza tıklayarak ekleyebilirsiniz.</p>';
                 return;
            }

            favoriteIds.forEach(studentId => {
                var studentData = allStudentsMap[studentId];
                if (!studentData) { 
                    console.warn('renderFavoritesTab: Öğrenci verisi (ID: ' + studentId + ') bulunamadı. (allStudentsMap henüz yüklenmemiş olabilir)');
                    return;
                }
                var el = document.createElement('div');
                // DEĞİŞİKLİK: py-2 -> py-1 (daha dar satır) ve space-y-1 kullanımı
                el.className = 'flex items-center justify-between gap-4 py-1 px-4 bg-white bg-opacity-10 rounded-lg border border-white border-opacity-20';
                
                // Format: (Sınıf)-ID-Ad Soyad
                var studentDisplayInfo = `(${studentData.sinif})-${studentId}-${titleTR(studentData.ad)} ${titleTR(studentData.soyad)}`;
                
                // DEĞİŞİKLİK: Baştaki yıldız ikonu kaldırıldı
                el.innerHTML = `
                    <div>
                        <button class="student-detail-trigger" data-student-id="${studentId}" data-student-name="${studentDisplayInfo}">
                            ${studentDisplayInfo}
                        </button>
                    </div>
                    <button class="text-red-400 hover:text-red-300 favorite-star favorited" data-student-id="${studentId}" aria-label="Favoriden Kaldır">
                         <ion-icon name="trash-outline" class="text-2xl"></ion-icon>
                    </button>
                `;
                
                // Silme butonu
                el.querySelector('.favorite-star').addEventListener('click', toggleFavorite);
                // YENİ: İsim butonu
                el.querySelector('.student-detail-trigger').addEventListener('click', function(e) {
                    var studentId = e.target.dataset.studentId;
                    var studentName = e.target.dataset.studentName;
                    launchStudentDetailModal(studentId, studentName);
                });

                container.appendChild(el);
            });
        }

function launchStudentDetailModal(studentId, studentName) {
            if (!studentId || !studentName) {
                showNotification("Öğrenci bilgisi alınamadı.", "error");
                return;
            }

            // Modalı göster, yükleniyor ekranını aç
            studentDetailModal.style.display = 'block';
            studentDetailModalTitle.textContent = `${studentName} Raporu`;
            studentDetailModalLoading.style.display = 'block';
            studentDetailModalContent.classList.add('hidden');
            
            // Global soru kaydı değişkenini temizle
            allQuestionEntries = {};
            
            // Dinleyiciyi sıfırla (varsa)
            database.ref('users/sorular/' + studentId).off('value');

            // Veritabanından bu öğrencinin tüm verilerini ÇEK
            database.ref('users/sorular/' + studentId).once('value')
                .then(snapshot => {
                    // Veriyi global değişkene ata
allQuestionEntries = snapshot.val() || {};

// -- Öğrenci değişince eski görünümleri sıfırla --
// 1) Günlük detay panelini temizle
try {
  const dd = document.getElementById('tsr-daily-details');
  const dtb = document.getElementById('tsr-details-table-body');
  if (dtb) dtb.innerHTML = '';
  if (dd) dd.classList.add('hidden');
} catch(e){ console.warn(e); }
// 2) Takvim/Chart instance'larını sıfırla (yeni veriyi anında çizmek için)
try {
  if (window.calendarInstances && calendarInstances['tsr']) { delete calendarInstances['tsr']; }
} catch(e){ console.warn(e); }
try {
  if (window.weeklyChartInstance && weeklyChartInstance['tsr']) { weeklyChartInstance['tsr'].destroy(); delete weeklyChartInstance['tsr']; }
} catch(e){ console.warn(e); }
try {
  if (window.monthlyChartInstance && monthlyChartInstance['tsr']) { monthlyChartInstance['tsr'].destroy(); delete monthlyChartInstance['tsr']; }
} catch(e){ console.warn(e); }

// 3) Sekme görsellerini "Günlük"e sabitle (her açılışta varsayılan)
try {
  const tabs = document.querySelectorAll('#studentDetailModal .student-detail-tab-button');
  const contents = document.querySelectorAll('#studentDetailModal .student-detail-tab-content');
  const activeTabClasses = ['bg-purple-600', 'text-white', 'shadow-md'];
  const inactiveTabClasses = ['text-gray-300', 'hover:bg-white', 'hover:bg-opacity-10'];
  tabs.forEach(item => { item.classList.remove(...activeTabClasses); item.classList.add(...inactiveTabClasses); });
  const dayTab = Array.from(tabs).find(t => t.dataset.tab === 'tsr-gunluk-rapor');
  if (dayTab) { dayTab.classList.add(...activeTabClasses); dayTab.classList.remove(...inactiveTabClasses); }
  contents.forEach(c => c.classList.remove('active'));
  const dayContent = document.getElementById('tsr-gunluk-rapor');
  if (dayContent) dayContent.classList.add('active');
} catch(e){ console.warn(e); }

                    // Yükleniyor ekranını gizle, içeriği göster
                    studentDetailModalLoading.style.display = 'none';
                    studentDetailModalContent.classList.remove('hidden');

                    // Rapor sekmelerini kur (ilk kez)
                    if (!studentDetailModal.dataset.tabsInitialized) {
                        setupTeacherStudentReportTabs();
                        studentDetailModal.dataset.tabsInitialized = 'true';
                    }
                    
                    // Varsayılan sekme olan "Günlük Rapor"u çiz
                    setupCalendar('tsr');
                })
                .catch(error => {
                    console.error("Öğrenci veri çekme hatası: ", error);
                    showNotification("Öğrenci verileri çekilirken hata oluştu.", "error");
                    studentDetailModalLoading.innerHTML = `<p class="text-red-400">Veri yüklenemedi.</p>`;
                });
        }

function setupTeacherStudentReportTabs() {
            const tabs = document.querySelectorAll('#studentDetailModal .student-detail-tab-button');
            const contents = document.querySelectorAll('#studentDetailModal .student-detail-tab-content');
            
            const activeTabClasses = ['bg-purple-600', 'text-white', 'shadow-md'];
            const inactiveTabClasses = ['text-gray-300', 'hover:bg-white', 'hover:bg-opacity-10'];

            tabs.forEach(tab => {
                tab.onclick = () => { // Zaten listener yok, 'onclick' kullanabiliriz
                    tabs.forEach(item => {
                        item.classList.remove(...activeTabClasses);
                        item.classList.add(...inactiveTabClasses);
                    });
                    tab.classList.add(...activeTabClasses);
                    tab.classList.remove(...inactiveTabClasses);

                    contents.forEach(content => content.classList.remove('active'));
                    
                    const targetId = tab.dataset.tab;
                    const targetContent = document.getElementById(targetId);
                    
                    if (targetContent) {
                        targetContent.classList.add('active');
                        
                        // Hangi sekme tıklandıysa ilgili raporu 'tsr-' önekiyle çiz
                        if (targetId === 'tsr-gunluk-rapor') {
                            setupCalendar('tsr');
                        } else if (targetId === 'tsr-haftalik-rapor') {
                            setupWeeklyReport('tsr');
                        } else if (targetId === 'tsr-aylik-rapor') {
                            setupMonthlyReport('tsr');
                        }
                    }
                };
            });

            // Varsayılan olarak ilk sekmeyi (Günlük) aktif yap
            if (tabs.length > 0) {
                tabs[0].click(); // click() ile tetikleyerek ilgili render'ı da başlat
            }
        }

function setupTeacherPanel() {
            const tabs = document.querySelectorAll('#teacher-panel .panel-tab-button');
            const contents = document.querySelectorAll('#teacher-panel .panel-tab-content');
            
            const activeTabClasses = ['bg-purple-600', 'text-white', 'shadow-md'];
            const inactiveTabClasses = ['text-gray-300', 'hover:bg-white', 'hover:bg-opacity-10'];

            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(item => {
                        item.classList.remove(...activeTabClasses);
                        item.classList.add(...inactiveTabClasses);
                    });
                    tab.classList.add(...activeTabClasses);
                    tab.classList.remove(...inactiveTabClasses);
                    contents.forEach(content => content.classList.remove('active'));
                    const targetId = tab.dataset.tab;
                    const targetContent = document.getElementById(targetId);
                    if (targetContent) {
                        targetContent.classList.add('active');
                    }
                });
            });

            if (tabs.length > 0) {
                tabs[0].classList.add(...activeTabClasses);
                tabs[0].classList.remove(...inactiveTabClasses);
            }
            if (contents.length > 0) {
                contents[0].classList.add('active');
            }

            (function setupTeacherCharts() {
                if (typeof Chart === 'undefined') return; 
                Chart.defaults.color = '#9ca3af'; 
                Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.1)'; 
                
                const barChartEl = document.getElementById('class-bar-chart');
                if (barChartEl) {
                    const ctxBar = barChartEl.getContext('2d');
                    if (window.teacherBarChart) { window.teacherBarChart.destroy(); }
                    
                    window.teacherBarChart = new Chart(ctxBar, {
                        type: 'bar',
                        data: { labels: [], datasets: [] },
                        options: {
                            responsive: true, maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: { y: { beginAtZero: true }, x: { grid: { display: false } } }
                        }
                    });
                }
            })();

(function setupSiniflarTab() {
  var sinifInput = document.getElementById('sinif-ekle-input');
  var sinifEkleBtn = document.getElementById('sinif-ekle-buton');
  var sinifListContainer = document.getElementById('sinif-listesi-container');
  var hataMesaji = document.getElementById('sinif-hata-mesaji');

  var studentListModal = document.getElementById('studentListModal');
  var studentListModalTitle = document.getElementById('studentListModalTitle');
  var studentListModalContent = document.getElementById('studentListModalContent');
  var closeStudentListModal = document.getElementById('closeStudentListModal');

  if (!studentListModal || !closeStudentListModal || !studentListModalTitle || !studentListModalContent) {
      console.error("Öğrenci listesi modal elementleri bulunamadı!");
      return;
  }
  
  function hideModal() { 
      if(studentListModal) studentListModal.style.display = 'none'; 
  }
  closeStudentListModal.addEventListener('click', hideModal);
  studentListModal.addEventListener('click', function(e) {
      if (e.target === studentListModal) {
          hideModal();
      }
  });

  if (!sinifInput || !sinifEkleBtn || !sinifListContainer || !hataMesaji) return;
  if (sinifListContainer.dataset.initialized) return;
  sinifListContainer.dataset.initialized = 'true';

  function showHata(mesaj){ hataMesaji.textContent = mesaj; hataMesaji.classList.remove('hidden'); }
  function hideHata(){ hataMesaji.classList.add('hidden'); }

  function render() {
    sinifListContainer.innerHTML = '';
    if (!classList || classList.length === 0) {
      sinifListContainer.innerHTML = '<p class="text-gray-400 text-sm italic md:col-span-2">Henüz hiç sınıf eklenmemiş.</p>';
      return;
    }
    classList.forEach(function(sinifAdi) {
      var el = document.createElement('div');
      el.className = 'class-card bg-white bg-opacity-10 p-4 rounded-lg shadow-sm';
      var header = document.createElement('div');
      header.className = 'flex items-center justify-between';
      
      header.innerHTML = ''
        + '<span class="sinif-title font-medium text-white text-lg cursor-pointer select-none" data-sinif="' + sinifAdi + '" tabindex="0">' + sinifAdi + '</span>'
        + '<button class="delete-sinif-btn text-red-400 hover:text-red-300 transition-colors" data-sinif="' + sinifAdi + '" aria-label="' + sinifAdi + ' sınıfını sil">'
        +   '<ion-icon name="trash-outline" class="text-2xl" style="pointer-events:none;"></ion-icon>'
        + '</button>';
      el.appendChild(header);
      sinifListContainer.appendChild(el);
    });
  }

  window.renderTeacherClassList = render;

  function ekleSinif() {
    var yeni = sinifInput.value.trim().toUpperCase();
    if (yeni === '') return showHata('Sınıf adı boş olamaz.');
    if (classList.indexOf(yeni) >= 0) return showHata('"' + yeni + '" zaten mevcut.');
    hideHata();
    database.ref(CLASSLIST_PATH + '/' + yeni).set(true)
      .then(function(){ sinifInput.value=''; })
      .catch(function(err){ showHata('Kayıt hatası: ' + err.message); });
  }

  function silSinif(evt) {
    var btn = evt.target.closest('.delete-sinif-btn');
    if (!btn) return;
    var s = btn.dataset.sinif;
    database.ref(CLASSLIST_PATH + '/' + s).remove()
      .catch(function(err){ showHata('Silme hatası: ' + err.message); });
  }

  function showStudentListModal(sinifAdi) {
      if (!sinifAdi) return;
      
      var students = (studentsByClass && studentsByClass[sinifAdi]) ? studentsByClass[sinifAdi] : [];
      studentListModalTitle.textContent = sinifAdi + ' Sınıf Listesi';
      
      if (!students || students.length === 0) {
        studentListModalContent.innerHTML = '<p class="text-gray-300 text-sm">Bu sınıfta kayıtlı öğrenci yok.</p>';
      } else {
        var ul = document.createElement('ul');
        ul.className = 'space-y-2';
        students.forEach(function(stu){
          var li = document.createElement('li');
          li.className = 'text-gray-100 text-sm p-2 bg-white bg-opacity-5 rounded transition-all hover:bg-white hover:bg-opacity-10 flex items-center justify-between';
          
          var liText = (stu.no || '') + ' - ' + titleTR(stu.ad || '') + ' ' + titleTR(stu.soyad || '');
          var isFavorited = teacherFavorites.hasOwnProperty(stu.no);
          var starIconName = isFavorited ? 'star' : 'star-outline';
          var favoritedClass = isFavorited ? 'favorited' : '';

          // DEĞİŞİKLİK: Öğrenci adı artık bir buton
          li.innerHTML = `
  <button class="student-detail-trigger" data-student-id="${stu.no}" data-student-name="${liText}">
      ${liText}
  </button>
  <div class="flex items-center gap-3">
      <button class="favorite-star ${favoritedClass}" data-student-id="${stu.no}" aria-label="Favoriye Ekle">
          <ion-icon name="${starIconName}"></ion-icon>
      </button>
      <button type="button" class="delete-student-btn text-red-400 hover:text-red-300 transition-colors" data-student-id="${stu.no}" data-student-name="${liText}" aria-label="Öğrenciyi Sil">
          <ion-icon name="trash-outline" class="text-2xl"></ion-icon>
      </button>
  </div>
`;
          ul.appendChild(li);
        });
        studentListModalContent.innerHTML = ''; 
        studentListModalContent.appendChild(ul);
      }
      studentListModal.style.display = 'block';
  }

  sinifListContainer.addEventListener('click', function(e){
    if (e.target.closest('.delete-sinif-btn')) {
      return; 
    }
    var card = e.target.closest('.class-card');
    if (card) {
        var titleEl = card.querySelector('.sinif-title');
        if(titleEl && titleEl.dataset.sinif) {
            showStudentListModal(titleEl.dataset.sinif);
        }
    }
  });
  
  sinifListContainer.addEventListener('keydown', function(e){
    var titleEl = e.target.closest('.sinif-title');
    if (titleEl && (e.key === 'Enter' || e.key === ' ')) {
      e.preventDefault();
      showStudentListModal(titleEl.dataset.sinif);
    }
  });

  // DEĞİŞİKLİK: Modal içeriği için olay delegasyonu güncellendi
  studentListModalContent.addEventListener('click', function(e) {
        // Silme butonuna mı tıklandı? (yıldızın sağındaki kırmızı çöp kutusu)\n  var delBtn = e.target.closest('.delete-student-btn');\n  if (delBtn) {\n      try{ e.preventDefault(); e.stopImmediatePropagation?.(); e.stopPropagation?.(); }catch(_){ }\n      var sid = delBtn.dataset.studentId;\n      var sname = delBtn.dataset.studentName || sid;\n      if (!sid) return;\n      if (!confirm(`${sname} öğrencisini ve tüm verilerini silmek istediğinize emin misiniz? Bu işlem geri alınamaz.`)) return;\n      var li = delBtn.closest('li');\n      deleteStudentCompletely(sid)\n        .then(function(){\n            showNotification('Öğrenci ve tüm verileri silindi.', 'success');\n            if (li) li.remove();\n        })\n        .catch(function(err){\n            showNotification('Silme hatası: ' + err.message, 'error');\n        });\n      return;\n  }\n// Favori yıldızına mı tıklandı?
      var starBtn = e.target.closest('.favorite-star');
      if (starBtn) {
          toggleFavorite(e); // Global favori fonksiyonunu çağır
          return;
      }
      
      // Öğrenci adına mı tıklandı?
      var detailBtn = e.target.closest('.student-detail-trigger');
      if (detailBtn) {
          var studentId = detailBtn.dataset.studentId;
          // studentName'i burada yeniden formatlamamız gerekiyor çünkü modal kapatılırken eski basit format kullanılıyor.
          var studentData = allStudentsMap[studentId];
          var studentName = `(${studentData.sinif})-${studentId}-${titleTR(studentData.ad)} ${titleTR(studentData.soyad)}`;
          
          hideModal(); // Küçük modalı kapat
          // Büyük modalı aç
          launchStudentDetailModal(studentId, studentName);
          return;
      }
  });

  sinifEkleBtn.addEventListener('click', ekleSinif);
  sinifInput.addEventListener('keypress', function(e){ if (e.key === 'Enter') ekleSinif(); });
  sinifListContainer.addEventListener('click', silSinif);

  render(); 
})();
        }

function loadTeacherData() {
            if (teacherDataListenersStarted) return;
            teacherDataListenersStarted = true;

            database.ref('users/ogrenciler').on('value', (snap) => {
                teacherStudents = snap.val() || {};
                recomputeTeacherSummary();
            });
            database.ref('users/sorular').on('value', (snap) => {
                teacherSorular = snap.val() || {};
                recomputeTeacherSummary();
            });
        }

function recomputeTeacherSummary() {
            const regCount = teacherStudents ? Object.keys(teacherStudents).length : 0;
            const regEl = document.getElementById('teacher-stat-registered');
            if (regEl) regEl.textContent = String(regCount);

            const today = new Date();
            today.setHours(0,0,0,0);
            const todayISO = new Date().toISOString().substring(0,10);

            const startOfWeek = new Date(today);
            startOfWeek.setDate(today.getDate() - today.getDay() + (today.getDay() === 0 ? -6 : 1));

            const monthPrefix = new Date().toISOString().substring(0,7); 

            const totalsDay = {};
            const totalsWeek = {};
            const totalsMonth = {};
            const classTotals = {};

            Object.keys(teacherSorular || {}).forEach((sid) => {
                const dates = teacherSorular[sid] || {};
                Object.keys(dates).forEach((dateKey) => {
                    const dersMap = dates[dateKey] || {};
                    let total = 0;
                    for (const ders in dersMap) {
                        const v = dersMap[ders] || {};
                        total += (Number(v.d) || 0) + (Number(v.y) || 0);
                    }
                    if (dateKey === todayISO) {
                        totalsDay[sid] = (totalsDay[sid] || 0) + total;
                    }
                    const d = new Date(dateKey);
                    d.setHours(0,0,0,0);
                    if (d >= startOfWeek && d <= today) {
                        totalsWeek[sid] = (totalsWeek[sid] || 0) + total;
                    }
                    if (dateKey.startsWith(monthPrefix)) {
                        totalsMonth[sid] = (totalsMonth[sid] || 0) + total;
                        const sinif = (teacherStudents[sid] && teacherStudents[sid].sinif) ? teacherStudents[sid].sinif : '—';
                        classTotals[sinif] = (classTotals[sinif] || 0) + total;
                    }
                });
            });

            function setWinner(elId, totalsObj) {
                const el = document.getElementById(elId);
                if (!el) return;
                let bestId = null, bestVal = 0;
                Object.keys(totalsObj).forEach((sid) => {
                    const v = totalsObj[sid] || 0;
                    if (v > bestVal) { bestVal = v; bestId = sid; }
                });
                if (!bestId) { el.textContent = '—'; el.parentElement?.setAttribute('title',''); return; }
                const stu = teacherStudents[bestId] || {};
                const name = [stu.ad, stu.soyad].filter(Boolean).join(' ') || bestId;
                const label = `${name} (${bestVal} Soru)`;
                el.textContent = label;
                el.parentElement?.setAttribute('title', label);
            }
            setWinner('teacher-stat-daily',  totalsDay);
            setWinner('teacher-stat-weekly', totalsWeek);
            setWinner('teacher-stat-monthly', totalsMonth);

            // DEĞİŞİKLİK: 'labels' artık 'classList' (tüm sınıflar) listesinden alınıyor.
            const labels = [...classList].sort(); // global classList'i kullan
            const dataArr = labels.map(l => classTotals[l] || 0); // Soru girmeyenler için 0 gelir
            
            const barEl = document.getElementById('class-bar-chart');
            if (barEl && barEl.getContext) {
                const ctx = barEl.getContext('2d');
                if (window.teacherBarChart) { window.teacherBarChart.destroy(); }
                window.teacherBarChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels, // Güncellenmiş etiket listesi
                        datasets: [{
                            label: 'Toplam Soru (Bu Ay)',
                            data: dataArr, // Güncellenmiş veri listesi
                            backgroundColor: 'rgba(168, 85, 247, 0.7)',
                            borderColor: 'rgba(192, 132, 252, 1)',
                            borderWidth: 1,
                            borderRadius: 5
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: { y: { beginAtZero: true }, x: { grid: { display: false } } }
                    }
                });
            }
        }

</script>

<script id="teacher-student-detail-modal-fixes">
(function(){
  var mdl = document.getElementById('studentDetailModal');
  var btn = document.getElementById('closeStudentDetailModal');
  function hide(){ if(mdl) mdl.style.display='none'; }
  if(btn && !btn.dataset.listenerAttached){ btn.addEventListener('click', hide); btn.dataset.listenerAttached='1'; }
  if(mdl && !mdl.dataset.backdropListenerAttached){
    mdl.addEventListener('click', function(e){ if(e.target === mdl) hide(); });
    document.addEventListener('keydown', function(e){ if(e.key === 'Escape') hide(); });
    mdl.dataset.backdropListenerAttached='1';
  }
  // Expose globals for modal render code
  window.studentDetailModal = mdl;
  window.studentDetailModalTitle = document.getElementById('studentDetailModalTitle');
  window.studentDetailModalLoading = document.getElementById('studentDetailModalLoading');
  window.studentDetailModalContent = document.getElementById('studentDetailModalContent');
})();
</script>





<script id="teacher-delete-student">
// Tüm öğrenci verilerini tek seferde sil (ogrenci, sorular, veli kaydı, favoriler)
// Root-level update bazı güvenlik kurallarında engellenebileceği için tek tek remove() kullanıyoruz.
function deleteStudentCompletely(studentId){
    if (!studentId) return Promise.reject(new Error("Öğrenci ID eksik"));
    var tasks = [];
    try {
        tasks.push(database.ref('users/ogrenciler/' + studentId).remove());
        tasks.push(database.ref('users/sorular/' + studentId).remove().catch(function(){ /* yoksa sorun değil */ }));
        tasks.push(database.ref('users/veliler/veli-' + studentId).remove().catch(function(){ /* yoksa sorun değil */ }));
        if (typeof FAVORITES_PATH !== 'undefined') {
            tasks.push(database.ref(FAVORITES_PATH + '/' + studentId).remove().catch(function(){ /* yoksa sorun değil */ }));
        }
    } catch (err) {
        return Promise.reject(err);
    }
    return Promise.all(tasks).then(function(){ return true; });
}
</script>


<script id="teacher-delete-student-listener">
// Yedek dinleyici: Olay yakalama aşamasında delete-student-btn tıklarını ele al.
document.addEventListener('click', function(e){
    var btn = e.target.closest && e.target.closest('.delete-student-btn');
    if (!btn) return;
    try{ e.stopImmediatePropagation && e.stopImmediatePropagation(); }catch(_){}
    try{ e.stopPropagation && e.stopPropagation(); }catch(_){}
    e.preventDefault && e.preventDefault();

    var sid = btn.getAttribute('data-student-id');
    var sname = btn.getAttribute('data-student-name') || sid || 'Öğrenci';
    if (!sid) return;

    if (!confirm(sname + " öğrencisini ve tüm verilerini silmek istediğinize emin misiniz? Bu işlem geri alınamaz.")) {
        return;
    }
    var li = btn.closest('li');

    deleteStudentCompletely(sid)
      .then(function(){
        if (typeof showNotification === 'function') {
            showNotification("Öğrenci ve tüm verileri silindi.", "success");
        }
        if (li) li.remove();
      })
      .catch(function(err){
        if (typeof showNotification === 'function') {
            showNotification("Silme hatası: " + (err && err.message ? err.message : err), "error");
        } else {
            alert("Silme hatası: " + (err && err.message ? err.message : err));
        }
      });
}, true); // capture
</script>


<script id="ghost-zero-init">
document.addEventListener('DOMContentLoaded', function () {
  const dogru = document.getElementById('dogru');
  const yanlis = document.getElementById('yanlis');
  const ders  = document.getElementById('ders');
  if (dogru && yanlis) {
    // Değerleri boşalt: placeholder '0' hayalet olarak görünsün
    dogru.value = '';
    yanlis.value = '';
    // Her ihtimale karşı fokus tıklandığında "0" varsa temizle
    ['focus','mousedown'].forEach(ev => {
      dogru.addEventListener(ev, () => { if (dogru.value === '0') dogru.value = ''; });
      yanlis.addEventListener(ev, () => { if (yanlis.value === '0') yanlis.value = ''; });
    });
  }
  // Ders seçildikten sonra alanları temizleyip hayalet 0 bırakalım
  if (ders && dogru && yanlis) {
    ders.addEventListener('change', () => {
      if (ders.value) {
        dogru.value = '';
        yanlis.value = '';
      }
    });
  }
});
</script>

<script id="topbar-gradient-overwrite">
  // Inline style'da !important varsa bile üzerine yazabilmek için JS ile ayarla
  document.addEventListener('DOMContentLoaded', function () {
    const grad = 'linear-gradient(90deg, #2F2A82 0%, #412683 50%, #532286 100%)';
    const t = document.querySelector('#teacher-panel > nav');
    if (t) { t.style.background = grad; }
    const s = document.querySelector('#student-panel > nav');
    if (s) { s.style.background = grad; }
  });
</script>

<script>
  function toTitleCaseTR(str) {
    if (!str) return '';
    return String(str)
      .trim()
      .split(/\s+/)
      .map(function(word){
        return word.split('-').map(function(seg){
          if (!seg) return seg;
          var first = seg.charAt(0).toLocaleUpperCase('tr-TR');
          var rest  = seg.slice(1).toLocaleLowerCase('tr-TR');
          return first + rest;
        }).join('-');
      })
      .join(' ');
  }
</script>

</body>
</html>

<!-- PATCH: Günlük Rapor Takvimi — Sıkı Yerleşim (v3, responsive) -->
<style id="calendar-compact-hard-override">
:root {
  --cal-cell: 48px;   /* mobile default */
  --cal-gap: 0px;     /* mobile: tam sıkı */
  --cal-font: 0.95rem;
}
@media (min-width: 640px){ :root{ --cal-cell: 56px; } }     /* sm */
@media (min-width: 768px){ :root{ --cal-cell: 64px; } }     /* md */
@media (min-width: 1024px){ :root{ --cal-cell: 72px; --cal-gap: 1px; --cal-font: 1.05rem; } } /* lg (desktop) */
@media (min-width: 1280px){ :root{ --cal-cell: 84px; --cal-gap: 1px; --cal-font: 1.125rem; } } /* xl */
@media (min-width: 1536px){ :root{ --cal-cell: 92px; --cal-gap: 1px; --cal-font: 1.15rem; } }  /* 2xl */

/* Öğrenci, Veli ve Öğretmen-Öğrenci (TSR) günlük takvim ızgaraları */
#student-calendar-grid,
#parent-calendar-grid,
#tsr-calendar-grid {
  grid-template-columns: repeat(7, var(--cal-cell)) !important;
  justify-content: center !important;
  gap: var(--cal-gap) !important;
  grid-gap: var(--cal-gap) !important;
  margin-left: auto !important;
  margin-right: auto !important;
}

/* Kare ve kompakt hücreler */
#student-calendar-grid .day-cell,
#parent-calendar-grid .day-cell,
#tsr-calendar-grid .day-cell {
  height: var(--cal-cell) !important;
  width: var(--cal-cell) !important;
  padding-top: 0 !important; /* padding hack'ini kapat */
}

/* Gün numarası boyutu ekranla ölçeklensin */
#student-calendar-grid .day-cell .day-cell-content,
#parent-calendar-grid .day-cell .day-cell-content,
#tsr-calendar-grid .day-cell .day-cell-content {
  border-radius: 0.5rem;
  font-size: var(--cal-font);
}
</style>

<script id="calendar-compact-align">
(function(){
  function applyCalendarSizing(){
    var root = getComputedStyle(document.documentElement);
    var cell = parseInt(root.getPropertyValue('--cal-cell')) || 48;
    var gap  = root.getPropertyValue('--cal-gap') || '0px';
    var width = (cell * 7) + 'px';
    var grids = ['student-calendar-grid','parent-calendar-grid','tsr-calendar-grid'];
    grids.forEach(function(id){
      var grid = document.getElementById(id);
      if(!grid) return;
      // Header satırını (gün isimleri) takvim genişliğine indir ve ortala
      var header = grid.previousElementSibling;
      if(header && header.classList && header.classList.contains('grid')){
        header.style.width = width;
        header.style.maxWidth = width;
        header.style.marginLeft = 'auto';
        header.style.marginRight = 'auto';
        header.style.gap = gap;
      }
      // Daha önce eklenmiş inline !important boşlukları 'var(--cal-gap)' olarak güncelle
      ['gap','grid-gap','row-gap','column-gap'].forEach(function(prop){
        grid.style.setProperty(prop, 'var(--cal-gap)', 'important');
      });
    });
  }
  // İlk çalıştırma ve yeniden boyutlandırmada uygula
  applyCalendarSizing();
  window.addEventListener('resize', applyCalendarSizing);
  // Geç yüklenen DOM için güvence
  document.addEventListener('DOMContentLoaded', applyCalendarSizing);
})();
</script>

